<link href="../site.css" rel="stylesheet" type="text/css"/>
<div class="mw-page-container"><h1 class="firstHeading mw-first-heading" id="firstHeading"><span class="mw-page-title-main">Macro Shake Sketch/fr</span></h1><div class="mw-parser-output"><div class="mw-pt-languages noprint" dir="ltr" lang="en"><div class="mw-pt-languages-label">Other languages:</div><ul class="mw-pt-languages-list"><li><a class="mw-pt-languages-ui mw-pt-progress mw-pt-progress--complete" dir="ltr" href="../Macro_Shake_Sketch.html" lang="en" title="Macro Shake Sketch (100% translated)">English</a></li>
<li><span class="mw-pt-languages-selected mw-pt-progress mw-pt-progress--complete" dir="ltr" lang="fr">français</span></li>
<li><a class="mw-pt-progress mw-pt-progress--low" dir="ltr" href="../it\Macro_Shake_Sketch.html" lang="it" title="Macro Scrolla lo schizzo (20% translated)">italiano</a></li>
<li><a class="mw-pt-progress mw-pt-progress--stub" dir="ltr" href="../pl\Macro_Shake_Sketch.html" lang="pl" title="Makrodefinicja: Szkic wstrząsu (10% translated)">polski</a></li></ul></div>
<table class="fcinfobox wikitable ct" style="float: right; width: 230px; margin-left: 10px;" width="100%">
<tbody><tr>
<td class="ctTitle" style="font-weight: bold; font-size: 125%;">
<p><span typeof="mw:File"><a class="mw-file-description" href="../File/Macro_Shake_Sketch.png"><img decoding="async" height="32" src="../File/Macro_Shake_Sketch.png" width="32"/></a></span><span> </span>
Macro Shake Sketch
</p>
</td></tr>
<tr>
<th class="ctOdd">Description
</th></tr>
<tr>
<td class="ctEven left macro-description">Secoue une esquisse afin de découvrir ses parties non contraintes. Mettez vous en mode édition dans une esquisse et lancez la macro. La macro ajoute un déplacement aléatoire sur tous les points de l'esquisse. Les contraintes de l'esquisse sont alors résolues, les parties contraintes conservent leur position, les parties libres se déplacent.<br/>
<p><span style="background-color:#ff0000; color:#ffff00;">(Utilisez les boutons Undo (Ctrl+Z) et Redo (Ctrl+Y) (étiqueté "Shake Sketch") ou travaillez sur une copie de votre fichier car la macro "démonte tout" pour afficher et vous devrez peut-être recommencer).</span><br/><br/>Version macro : 1.3<br/>Date dernière modification : 2022-06-01<br/>Version FreeCAD : Toutes<br/>Téléchargement : <a class="external text" href="https://www.freecadweb.org/wiki/images/4/4a/Macro_Shake_Sketch.png" rel="nofollow">Icône de la barre d'outils</a><br/>Auteur: Gaël Ecorchard, heda<br/>
</p>
</td></tr>
<tr>
<th class="ctOdd">Auteur
</th></tr>
<tr>
<td class="ctEven macro-author"><a class="new" href="../index.php?title=User;Ga%C3%ABl_Ecorchard,_heda&amp;action=edit&amp;redlink=1.html" title="User:Gaël Ecorchard, heda (page does not exist)">Gaël Ecorchard, heda</a>
</td></tr>
<tr>
<th class="ctOdd">Téléchargement
</th></tr>
<tr>
<td class="ctEven macro-download"><a class="external text" href="https://www.freecadweb.org/wiki/images/4/4a/Macro_Shake_Sketch.png" rel="nofollow">Icône de la barre d'outils</a>
</td></tr>
<tr>
<th class="ctOdd">Liens
</th></tr>
<tr>
<td class="ctEven macro-Links"><a href="../fr\Macros_recipes.html" title="Macros recipes/fr">Page des macros</a><br/><a href="../fr\How_to_install_macros.html" title="How to install macros/fr">Comment installer une macro</a><br/><a href="../fr\Customize_Toolbars.html" title="Customize Toolbars/fr">Comment créer une barre d'outils</a>
</td></tr>
<tr>
<th class="ctOdd">Version Macro
</th></tr>
<tr>
<td class="ctEven macro-version">1.3
</td></tr>
<tr>
<th class="ctOdd">Dernière modification
</th></tr>
<tr>
<td class="ctEven macro-date">2022-06-01
</td></tr>
<tr>
<th class="ctOdd">Version(s) FreeCAD
</th></tr>
<tr>
<td class="ctEven FreeCAD-version">Toutes
</td></tr>
<tr>
<th class="ctOdd">Raccourci clavier
</th></tr>
<tr>
<td class="ctEven"><i>None</i>
</td></tr>
<tr>
<th class="ctOdd">Voir aussi
</th></tr>
<tr>
<td class="ctEven"><i>None</i>
</td></tr>
<tr>
<th class="ctOdd">
</th></tr>
<tr>
<td class="ctToc"><br/><div aria-labelledby="mw-toc-heading" class="toc" id="toc" role="navigation"><input class="toctogglecheckbox" id="toctogglecheckbox" role="button" style="display:none" type="checkbox"/><div class="toctitle" dir="ltr" lang="en"><h2 id="mw-toc-heading">Contents</h2><span class="toctogglespan"><label class="toctogglelabel" for="toctogglecheckbox"></label></span></div>
<ul>
<li class="toclevel-1 tocsection-1"><a href="#Description"><span class="tocnumber">1</span> <span class="toctext">Description</span></a></li>
<li class="toclevel-1 tocsection-2"><a href="#Installation"><span class="tocnumber">2</span> <span class="toctext">Installation</span></a></li>
<li class="toclevel-1 tocsection-3"><a href="#Script"><span class="tocnumber">3</span> <span class="toctext">Script</span></a></li>
</ul>
</div>
</td></tr>
</tbody></table>
<h2><span class="mw-headline" id="Description">Description</span></h2>
<p>Secoue une esquisse pour révéler ses parties non-contraintes.
</p><p>Entrez en mode édition d'une esquisse et lancez la macro. Cette macro ajoute un déplacement aléatoire à tous les points de l'esquisse. Les contraintes de l'esquisse sont alors résolues, les parties contraintes gardent leur position et les parties libres bougent. Exécutez toujours cette macro sur une copie de l'esquisse originale.
</p><p>Rétablissez l'esquisse origine à l'aide des boutons <b>Undo (Ctrl+Z)</b> et <b>Redo (Ctrl+Y)</b> (intitulés "Shake Sketch") ou <b>faites attention en travaillant sur une copie de votre fichier car la macro </b>démonte tout<b> pour la visualisation et vous devrez peut-être recommencer.</b>
</p><p><span id="Install"></span>
</p>
<h2><span class="mw-headline" id="Installation">Installation</span></h2>
<p>Disponible dans le gestionnaire des extensions ou par installation manuelle.
</p>
<h2><span class="mw-headline" id="Script">Script</span></h2>
<p>Icône de la barre d'outils
<span class="mw-default-size" typeof="mw:File"><a class="mw-file-description" href="../File/Macro_Shake_Sketch.png"><img decoding="async" height="64" src="../File/Macro_Shake_Sketch.png" width="64"/></a></span>
</p><p><b>Macro Shake_Sketch.py</b>
</p>
<pre># -*- coding: utf-8 -*-

# FreeCAD macro to shake a sketch in order to discover its unconstrained parts.
#
# A Gaussian noise is introduced in all sketch points and the sketch is then
# solved.
# Beware that the sketch can look different because some constraints have
# several solutions. In this case, just undo.
#
# This file is released under the MIT License.
# Author: Gaël Ecorchard v1.0 &amp; v1.1
# Author: heda v1.2
# Version:
# - 1.3: 2022-06-01
#       * added openTransaction(u"Shake Sketch") for restore the original Sketch
# - 1.2: 2021-10-22
#       * made macro runnable for current versions of fc
#       * added Part.LineSegment
#       * added start info &amp; result dialogue
#       * hides constraints during shake
#       * added simple debug printing
# - 1.1: 2014-10-31
#       * correct import for Part
# - 1.0: 2014-08
#       * first release
# Amplitude of the point displacements.
# The standard deviation of the Gaussian noise is the largest sketch dimension
# multiplied by this factor.

__title__ = 'Sketch Shaker'
__version__ = '1.3'
__date__ = '2022/06/01'
__icon__ = 'https://wiki.freecadweb.org/images/4/4a/Macro_Shake_Sketch.png'

displacement_amplitude = 0.1
debug_print = False

# End of configuration.

from random import gauss

from PySide.QtGui import QMessageBox

import FreeCADGui as Gui
from FreeCAD import Base
import Part

print('Running Macro ' + __title__ + ' ver: ' + __version__)
FreeCAD.ActiveDocument.openTransaction(u"Shake Sketch")    # memorise les actions (avec annuler restore)

# For each sketch geometry type, map a list of points to move.
g_geom_points = {
    Base.Vector: [1],
    Part.Line: [1, 2],  # first point, last point
    Part.LineSegment: [1, 2],  # first point, last point
    Part.Circle: [0, 3],  # curve, center
    Part.ArcOfCircle: [1, 2, 3],  # first point, last point, center
} # moves bsplines and conics via lines and circles, no op for Part.Points


def dprint(msg, *args):
    if debug_print:
        if args:
            print(msg.format(*args))
        else:
            print(msg)

class BoundingBox:
    xmin = xmax = ymin = ymax = None

    def enlarge_x(self, x):
        if self.xmin is None:
            self.xmin = self.xmax = x
        elif self.xmin &gt; x:
            self.xmin = x
        elif self.xmax &lt; x:
            self.xmax = x

    def enlarge_y(self, y):
        if self.ymin is None:
            self.ymin = self.ymax = y
        elif self.ymin &gt; y:
            self.ymin = y
        elif self.ymax &lt; y:
            self.ymax = y

    def enlarge_point(self, point):
        self.enlarge_x(point.x)
        self.enlarge_y(point.y)

    def enlarge_line(self, line):
        self.enlarge_x(line.StartPoint.x)
        self.enlarge_x(line.EndPoint.x)
        self.enlarge_y(line.StartPoint.y)
        self.enlarge_y(line.EndPoint.y)

    def enlarge_circle(self, circle):
        self.enlarge_x(circle.Center.x - circle.Radius)
        self.enlarge_x(circle.Center.x + circle.Radius)
        self.enlarge_y(circle.Center.y - circle.Radius)
        self.enlarge_y(circle.Center.y + circle.Radius)

    def enlarge_arc_of_circle(self, arc):
        # TODO: correctly compute the arc extrema (cf. toShape().BoundBox)
        self.enlarge_x(arc.Center.x)
        self.enlarge_y(arc.Center.y)


def get_sketch_dims(sketch):
    bbox = BoundingBox()
    for geom in sketch.Geometry:
        if isinstance(geom, Base.Vector):
            bbox.enlarge_point(geom)
        elif isinstance(geom, (Part.Line, Part.LineSegment)):
            bbox.enlarge_line(geom)
        elif isinstance(geom, Part.Circle):
            bbox.enlarge_circle(geom)
        elif isinstance(geom, Part.ArcOfCircle):
            bbox.enlarge_arc_of_circle(geom)
    if None in (bbox.xmin, bbox.ymin):
        dprint('sketch bbox not found')
        return 0, 0
    else:
        dprint('sketch bbox found')
        return bbox.xmax - bbox.xmin, bbox.ymax - bbox.ymin


def add_noise(point, sigma):
    """Add a Gaussian noise with standard deviation sigma"""
    dprint('  x0:{:&gt;9.3f}  y0:{:&gt;9.3f}', point.x, point.y)
    point.x = gauss(point.x, sigma)
    point.y = gauss(point.y, sigma)
    dprint('  xt:{:&gt;9.3f}  yt:{:&gt;9.3f}', point.x, point.y)


def move_points(sketch, geom_index, sigma):
    point_indexes = g_geom_points.get(type(sketch.Geometry[i]), [])
    # Direct access to sketch.Geometry[index] does not work. This would,
    # however prevent repeated recompute.
    # not checked validity of comment for v1.2
    moved = False
    for point_index in point_indexes:
        dprint('---- geo idx [{:&gt;3} ] -- pt idx [{:&gt;3} ] ----',
               geom_index, point_index)
        point = sketch.getPoint(geom_index, point_index)
        add_noise(point, sigma)
        try:
            sketch.movePoint(geom_index, point_index, point)
        except ValueError as e:
            dprint(repr(e))
        new_pos = sketch.getPoint(geom_index, point_index)
        test = point.isEqual(new_pos, 0)
        dprint('  did it move? {}', test)
        if test: moved = True
    return moved

def toggle_constraints(sketch, toggle):
    for cid in toggle:
        sketch.toggleVirtualSpace(cid)
    

view_provider = Gui.activeDocument().getInEdit()

shake_it = False
if not view_provider:
    msg = 'A sketch needs to be in edit to be shaken.'
    print(msg)
    _ = QMessageBox.information(None, __title__, msg)
else:
    sketch = view_provider.Object
    if sketch.TypeId == 'Sketcher::SketchObject':
        sketch.recompute() # ensure update
        to_virtual = [cid for cid, cts in enumerate(sketch.Constraints)
                      if cts.InVirtualSpace]
        sketch_span = get_sketch_dims(sketch)
        sigma = max(sketch_span) * displacement_amplitude
        dprint('sketch span: dx:{:&gt;9.3f} dy:{:&gt;9.3f}', *sketch_span)
        dprint('sigma for gauss-dist: {:.3f}', sigma)
        toggle_constraints(sketch, to_virtual)
        msg = ('Shake sketch will deform the loose parts of the sketch.\n'
               'The deformation can be restored with : \n'
               'the Undo (Ctrl+Z) and Redo (Ctrl+Y) button (labeled "Shake Sketch").\n'
               'If that is not desired, click Cancel,\n'
               'and run the macro on a copy of the sketch.\n\n'
               'Visibility of constraints has been toggled.\n'
               'Visibility of constraints is restored'
               ' after shaking the sketch.')
        reply = QMessageBox.information(None, 'Running Macro ' + __title__ + ' ver: ' + __version__, msg,
                                        QMessageBox.Ok | QMessageBox.Cancel,
                                        QMessageBox.Ok)
        shake_it = reply == QMessageBox.Ok
        
        if not shake_it:
            toggle_constraints(sketch, to_virtual)

if shake_it:
    nbr_moves = 0
    for i in range(sketch.GeometryCount):
        did_move = move_points(sketch, i, sigma)
        if did_move:
            nbr_moves += 1

    msg = 'Did {} moves. Sketch has a total of {} geometry entities.\n\n'
    msg = msg.format(nbr_moves, sketch.GeometryCount)
    open_verts = sketch.OpenVertices
    if open_verts:
        if len(open_verts) == 1:
            ov, form = 'one', 'vertex'
        else:
            ov, form = len(open_verts), 'vertices'
        msg += 'Sketch has {} open {}.'.format(ov, form)
        msg += ('\nA sketch with open vertices'
                ' cannot be used to create a solid.')
    else:
        msg += 'Sketch is free from open vertices.'

    msg += ('\n\nMenu: "Sketch/Validate Sketch..." can be used\n'
            'for additional info about sketch status.')
    
    _ = QMessageBox.information(None, 'Running Macro ' + __title__ + ' ver: ' + __version__, msg)
    toggle_constraints(sketch, to_virtual)
        

print('Macro finished.')
</pre>
<div style="clear:both"></div>
<!-- 
NewPP limit report
Cached time: 20241214204333
Cache expiry: 86400
Reduced expiry: false
Complications: [show‐toc, no‐toc‐conversion]
CPU time usage: 0.054 seconds
Real time usage: 0.086 seconds
Preprocessor visited node count: 95/1000000
Post‐expand include size: 3210/2097152 bytes
Template argument size: 1545/2097152 bytes
Highest expansion depth: 6/100
Expensive parser function count: 0/100
Unstrip recursion depth: 0/20
Unstrip post‐expand size: 8652/5000000 bytes
-->
<!--
Transclusion expansion time report (%,ms,calls,template)
100.00%    3.995      1 -total
 67.09%    2.680      1 Template:Macro/fr
 27.08%    1.082      1 Template:Clear
 23.45%    0.937      1 Template:ColoredText
-->
<!-- Saved in parser cache with key freecadweb_db01-wiki_:pcache:idhash:40777-0!canonical and timestamp 20241214204333 and revision id 1304215. Rendering was triggered because: api-parse
 -->
</div></div><script src="../script.js"></script>
