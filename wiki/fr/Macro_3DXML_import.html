<link href="../site.css" rel="stylesheet" type="text/css"/>
<div class="mw-page-container"><h1 class="firstHeading mw-first-heading" id="firstHeading"><span class="mw-page-title-main">Macro 3DXML import/fr</span></h1><div class="mw-parser-output"><div class="mw-pt-languages noprint" dir="ltr" lang="en"><div class="mw-pt-languages-label">Other languages:</div><ul class="mw-pt-languages-list"><li><a class="mw-pt-languages-ui mw-pt-progress mw-pt-progress--complete" dir="ltr" href="Macro_3DXML_import.html" lang="en" title="Macro 3DXML import (100% translated)">English</a></li>
<li><span class="mw-pt-languages-selected mw-pt-progress mw-pt-progress--complete" dir="ltr" lang="fr">français</span></li>
<li><a class="mw-pt-progress mw-pt-progress--stub" dir="ltr" href="Macro_3DXML_import.html" lang="pl" title="Makrodefinicja: Import 3DXML (7% translated)">polski</a></li></ul></div>
<table class="fcinfobox wikitable ct" style="float: right; width: 230px; margin-left: 10px;" width="100%">
<tbody><tr>
<td class="ctTitle" style="font-weight: bold; font-size: 125%;">
<p><span typeof="mw:File"><a class="mw-file-description" href="../File/Text-x-python.png" title="Generic macro icon"><img alt="Generic macro icon" decoding="async" height="32" src="../File/Text-x-python.png" srcset="/images/2/2c/Text-x-python.png 1.5x" width="32"/></a></span><span> </span>
3DXML_import
</p>
</td></tr>
<tr>
<th class="ctOdd">Description
</th></tr>
<tr>
<td class="ctEven left macro-description">Importe un fichier 3DXML-ascii dans FreeCAD.<br/><br/>Version macro : 0.1<br/>Date dernière modification : 2021-10-03<br/>Version FreeCAD : -<br/>Auteur: heda<br/>
</td></tr>
<tr>
<th class="ctOdd">Auteur
</th></tr>
<tr>
<td class="ctEven macro-author"><a class="new" href="index.php?title=User;Heda&amp;action=edit&amp;redlink=1.html" title="User:Heda (page does not exist)">heda</a>
</td></tr>
<tr>
<th class="ctOdd">Téléchargement
</th></tr>
<tr>
<td class="ctEven macro-download"><i>None</i>
</td></tr>
<tr>
<th class="ctOdd">Liens
</th></tr>
<tr>
<td class="ctEven macro-Links"><a href="Macros_recipes.html" title="Macros recipes/fr">Page des macros</a><br/><a href="How_to_install_macros.html" title="How to install macros/fr">Comment installer une macro</a><br/><a href="Customize_Toolbars.html" title="Customize Toolbars/fr">Comment créer une barre d'outils</a>
</td></tr>
<tr>
<th class="ctOdd">Version Macro
</th></tr>
<tr>
<td class="ctEven macro-version">0.1
</td></tr>
<tr>
<th class="ctOdd">Dernière modification
</th></tr>
<tr>
<td class="ctEven macro-date">2021-10-03
</td></tr>
<tr>
<th class="ctOdd">Version(s) FreeCAD
</th></tr>
<tr>
<td class="ctEven FreeCAD-version">-
</td></tr>
<tr>
<th class="ctOdd">Raccourci clavier
</th></tr>
<tr>
<td class="ctEven"><i>None</i>
</td></tr>
<tr>
<th class="ctOdd">Voir aussi
</th></tr>
<tr>
<td class="ctEven"><i>None</i>
</td></tr>
<tr>
<th class="ctOdd">
</th></tr>
<tr>
<td class="ctToc"><br/><div aria-labelledby="mw-toc-heading" class="toc" id="toc" role="navigation"><input class="toctogglecheckbox" id="toctogglecheckbox" role="button" style="display:none" type="checkbox"/><div class="toctitle" dir="ltr" lang="en"><h2 id="mw-toc-heading">Contents</h2><span class="toctogglespan"><label class="toctogglelabel" for="toctogglecheckbox"></label></span></div>
<ul>
<li class="toclevel-1 tocsection-1"><a href="#Description"><span class="tocnumber">1</span> <span class="toctext">Description</span></a></li>
<li class="toclevel-1 tocsection-2"><a href="#Utilisation"><span class="tocnumber">2</span> <span class="toctext">Utilisation</span></a></li>
<li class="toclevel-1 tocsection-3"><a href="#Installation"><span class="tocnumber">3</span> <span class="toctext">Installation</span></a></li>
<li class="toclevel-1 tocsection-4"><a href="#Lien"><span class="tocnumber">4</span> <span class="toctext">Lien</span></a></li>
<li class="toclevel-1 tocsection-5"><a href="#Version"><span class="tocnumber">5</span> <span class="toctext">Version</span></a></li>
<li class="toclevel-1 tocsection-6"><a href="#Code"><span class="tocnumber">6</span> <span class="toctext">Code</span></a></li>
</ul>
</div>
</td></tr>
</tbody></table>
<h2><span class="mw-headline" id="Description">Description</span></h2>
<p>Cette macro importe un fichier 3DXML-ascii, avec l'option d'inclure les arêtes et/ou les mailles. Il existe d'autres types de fichiers 3DXML que le type ascii, les autres types ne peuvent pas être importés avec cette macro.
</p><p>La macro n'a été testée que sur un seul fichier, les fonctionnalités implémentées sont limitées à ce qui était disponible dans ce fichier. Si d'autres fichiers de test sont mis à disposition, la macro pourrait éventuellement être étendue pour couvrir des fonctionnalités supplémentaires. Chacun est libre de modifier et d'améliorer la macro, le mieux étant de la modifier ici sur le Wiki. Plus d'informations dans la <code>docstring</code> de la macro.
</p>
<h2><span class="mw-headline" id="Utilisation">Utilisation</span></h2>
<p>Exécutez la macro et sélectionnez un fichier.
</p>
<h2><span class="mw-headline" id="Installation">Installation</span></h2>
<p>Avec le gestionnaire des extensions.
</p>
<h2><span class="mw-headline" id="Lien">Lien</span></h2>
<p>Forum :  Pas de fil de discussion dédié, mais issu du <a class="external text" href="https://forum.freecadweb.org/viewtopic.php?f=8&amp;t=28199" rel="nofollow">forum post</a>.
</p>
<h2><span class="mw-headline" id="Version">Version</span></h2>
<p>v0.1 2021-10-03 : première version
</p>
<h2><span class="mw-headline" id="Code">Code</span></h2>
<p><b>Macro_3DXML_import.FCMacro</b>
</p>
<pre>#!/usr/bin/env python3
# -*- coding: utf-8 -*-

# ***************************************************************************
# *   Copyright (c) 2021 heda &lt;heda @ freecad forum&gt;                        *
# *                                                                         *
# *   This file is part of the FreeCAD CAx development system.              *
# *                                                                         *
# *   This program is free software; you can redistribute it and/or modify  *
# *   it under the terms of the GNU Lesser General Public License (LGPL)    *
# *   as published by the Free Software Foundation; either version 2 of     *
# *   the License, or (at your option) any later version.                   *
# *   for detail see the LICENCE text file.                                 *
# *                                                                         *
# *   This program is distributed in the hope that it will be useful,       *
# *   but WITHOUT ANY WARRANTY; without even the implied warranty of        *
# *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the         *
# *   GNU Library General Public License for more details.                  *
# *                                                                         *
# *   You should have received a copy of the GNU Library General Public     *
# *   License along with this program; if not, write to the Free Software   *
# *   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  *
# *   USA                                                                   *
# *                                                                         *
# ***************************************************************************


__Name__ = '3DXML_import'
__Comment__ = 'Imports a 3DXML-ascii file to FreeCAD'
__Author__ = 'heda @ fc-forum'
__Version__ = '0.1'
__Date__ = '2021-10-03'
__License__ = 'LGPL-2.0-or-later'
__Web__ = ''
__Wiki__ = 'https://wiki.freecadweb.org/Macro_3DXML_import'
__Icon__ = ''
__Help__ = 'Launch macro and select file.'
__Status__ = 'Stable'
__Requires__ = 'tested on FreeCAD v0.19'
__Communication__ = 'forum'
__Files__ = ''


__doc__ = """
The 3DXML file format allows for multiple types of representations.
This macro is limited to human readable content in the files,
i.e. the ascii tesselated type of geometry definition.
This type of geometry definition includes polylines as edges of geometry,
and meshes (like stl files).

The macro in current state requires a readable xml-file of type ".3DRep".

Import of edges is by default off, since that is the operation taking the
longest time.

It is recommended to run a mesh analysis after import to for example
remove duplicate points or correct flipped normals.

This macro is created using only one reference file (with only "strips" as
facets), thus it's applicability on other .3DRep files is currently unknown.
If other test files are made available, the macro can be updated.
"""

import FreeCAD as App
import Part, Mesh
from PySide import QtGui
import xml.etree.ElementTree as ET

IMPORT_EDGES, MERGE_EDGES = False, False
IMPORT_MESHES, MERGE_MESHES = True, True

filename, filt = QtGui.QFileDialog.getOpenFileName(filter='*.3DRep')

if not filename:
    raise UserWarning('Need to select a 3DRep file.')

print('Importing: {}'.format(filename))
doc = App.ActiveDocument

tree = ET.parse(filename)
root = tree.getroot()

# get namespaces from xml
ns = dict([node for _, node in
           ET.iterparse(filename, events=['start-ns'])])
if ns.get('') != 'http://www.3ds.com/xsd/3DXML':
    raise UserWarning('did not find expected namespace, file malformed?')
ns.update({'3dx':ns.get('')})


def parse_verts(vertbuffer):
    def floatify(xyz):
        return tuple((float(i) for i in xyz.split()))
    return [floatify(v) for v in vertbuffer.split(',')]

def parse_strips(strips):
    return (tuple(int(i) for i in strip.split())
            for strip in strips.split(','))

def make_mesh(element):
    Faces, VertexBuffer, SurfaceAttributes = list(element)
    Color = Faces.find('.//3dx:Color', ns)
    RGBA = tuple((float(i) for i in tuple(Color.attrib.values())[1:]))
    Face = Faces.find('.//3dx:Face', ns)
    strips = Face.get('strips')
    facets = list()
    if strips:
        Positions, Normals = list(VertexBuffer)
        facetverts = fv = parse_verts(Positions.text)
        for strip in parse_strips(strips):
            facetidx = zip(strip, strip[1:], strip[2:])
            facets += [tuple(fv[i] for i in pidx) for pidx in facetidx]
    else:
        print('face type undefined')
    return Mesh.Mesh(facets), RGBA


for BagRepType in root.findall('3dx:Root/3dx:Rep', ns):
    edges, meshes = list(), list()
    for PolygonalRepType in BagRepType:
        if PolygonalRepType.find('./3dx:Edges', ns):
            if not IMPORT_EDGES:
                continue
            Edges = PolygonalRepType.find('./3dx:Edges', ns)
            for polyline in Edges.findall('./3dx:Polyline', ns):
                verts = parse_verts(polyline.get('vertices'))
                edges.append(Part.makePolygon(verts))
                
        elif PolygonalRepType.find('./3dx:Faces', ns):
            print('  found face element')
            if not IMPORT_MESHES:
                continue
            mesh = make_mesh(PolygonalRepType)
            meshes.append(mesh)

    if edges:
        print('  creating edges')
        edgegroup = doc.addObject('App::DocumentObjectGroup','Edges')
        wires = list()
        if MERGE_EDGES:
            _edges = list()
            for _edge in edges:
                _edges += _edge.Edges
            for swire in Part.sortEdges(_edges):
                wire = Part.Wire(swire)
                obj = doc.addObject('Part::Feature', 'Edge')
                obj.Shape = wire
                wires.append(obj)
        else:
            for edge in edges:
                obj = doc.addObject('Part::Feature', 'Edge')
                obj.Shape = edge
                wires.append(obj)
        edgegroup.addObjects(wires)

    if meshes:
        print('  creating meshes')
        meshgroup = doc.addObject('App::DocumentObjectGroup','Meshes')
        meshobjs = list()
        if MERGE_MESHES:
            mesh_assembled = Mesh.Mesh()
            for mesh, RGBA in meshes:
                mesh_assembled.addMesh(mesh)
            obj = doc.addObject('Mesh::Feature', 'Mesh')
            obj.Mesh = mesh_assembled
            obj.ViewObject.ShapeColor = RGBA
            meshobjs.append(obj)
        else:
            for mesh, RGBA in meshes:
                obj = doc.addObject('Mesh::Feature', 'Mesh')
                obj.Mesh = mesh
                obj.ViewObject.ShapeColor = RGBA
                meshobjs.append(obj)
        meshgroup.addObjects(meshobjs)

doc.recompute()
print('... completed import')

# end</pre>
<!-- 
NewPP limit report
Cached time: 20241129212927
Cache expiry: 86400
Reduced expiry: false
Complications: [show‐toc, no‐toc‐conversion]
CPU time usage: 0.043 seconds
Real time usage: 0.080 seconds
Preprocessor visited node count: 99/1000000
Post‐expand include size: 1896/2097152 bytes
Template argument size: 7026/2097152 bytes
Highest expansion depth: 7/100
Expensive parser function count: 2/100
Unstrip recursion depth: 0/20
Unstrip post‐expand size: 7531/5000000 bytes
-->
<!--
Transclusion expansion time report (%,ms,calls,template)
100.00%    7.981      1 -total
 42.01%    3.353      1 Template:Macro/fr
 35.72%    2.851      1 Template:MacroCode
 20.44%    1.631      1 Template:Incode
-->
<!-- Saved in parser cache with key freecadweb_db01-wiki_:pcache:idhash:268866-0!canonical and timestamp 20241129212926 and revision id 1210530. Rendering was triggered because: api-parse
 -->
</div></div><script src="../script.js"></script>
