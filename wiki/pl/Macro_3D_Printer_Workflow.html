<link href="../site.css" rel="stylesheet" type="text/css"/>
<div class="mw-page-container"><h1 class="firstHeading mw-first-heading" id="firstHeading"><span class="mw-page-title-main">Macro 3D Printer Workflow/pl</span></h1><div class="mw-parser-output"><div class="mw-pt-languages noprint" dir="ltr" lang="en"><div class="mw-pt-languages-label">Other languages:</div><ul class="mw-pt-languages-list"><li><a class="mw-pt-languages-ui mw-pt-progress mw-pt-progress--complete" dir="ltr" href="../Macro_3D_Printer_Workflow.html" lang="en" title="Macro 3D Printer Workflow (100% translated)">English</a></li>
<li><a class="mw-pt-progress mw-pt-progress--complete" dir="ltr" href="../fr\Macro_3D_Printer_Workflow.html" lang="fr" title="Macro 3D Printer Workflow (100% translated)">français</a></li>
<li><span class="mw-pt-languages-selected mw-pt-progress mw-pt-progress--stub" dir="ltr" lang="pl">polski</span></li></ul></div>
<div class="mw-content-ltr" dir="ltr" lang="en">
<table class="fcinfobox wikitable ct" style="float: right; width: 230px; margin-left: 10px;" width="100%">
<tbody><tr>
<td class="ctTitle" style="font-weight: bold; font-size: 125%;">
<p><span typeof="mw:File"><a class="mw-file-description" href="../File/Macro_3D_Printer_Workflow.png"><img decoding="async" height="32" src="../File/Macro_3D_Printer_Workflow.png" width="32"/></a></span><span> </span>
Macro 3D Printer Workflow
</p>
</td></tr>
<tr>
<th class="ctOdd">Description
</th></tr>
<tr>
<td class="ctEven left macro-description">Macro that creates an stl file with perfect rounding, i.e. without visible facets, from selected objects. It also allows to launch programs of your choice. For example to automate the FreeCAD → Slicer → printing workflow.<br/>
<p>After the creation of the stl file you can, for example, open your slicer with the stl file, switch on your printer, heat the printer bed and, if necessary, trigger additional commands in your home automation.<br/><br/>Macro version: 00.02<br/>Last modified: 2023-01-21<br/>FreeCAD version: All<br/>Download: <a class="external text" href="https://wiki.freecadweb.org/images/b/b4/Macro_3D_Printer_Workflow.png" rel="nofollow">ToolBar icon</a><br/>Author: 2cv001<br/>
</p>
</td></tr>
<tr>
<th class="ctOdd">Author
</th></tr>
<tr>
<td class="ctEven macro-author"><a class="new" href="../index.php?title=User;2cv001&amp;action=edit&amp;redlink=1.html" title="User:2cv001 (page does not exist)">2cv001</a>
</td></tr>
<tr>
<th class="ctOdd">Download
</th></tr>
<tr>
<td class="ctEven macro-download"><a class="external text" href="https://wiki.freecadweb.org/images/b/b4/Macro_3D_Printer_Workflow.png" rel="nofollow">ToolBar icon</a>
</td></tr>
<tr>
<th class="ctOdd">Links
</th></tr>
<tr>
<td class="ctEven macro-Links"><a href="../Macros_recipes.html" title="Macros recipes">Macros recipes</a><br/><a href="../How_to_install_macros.html" title="How to install macros">How to install macros</a><br/><a href="../Customize_Toolbars.html" title="Customize Toolbars">How to customize toolbars</a>
</td></tr>
<tr>
<th class="ctOdd">Macro Version
</th></tr>
<tr>
<td class="ctEven macro-version">00.02
</td></tr>
<tr>
<th class="ctOdd">Date last modified
</th></tr>
<tr>
<td class="ctEven macro-date">2023-01-21
</td></tr>
<tr>
<th class="ctOdd">FreeCAD Version(s)
</th></tr>
<tr>
<td class="ctEven FreeCAD-version">All
</td></tr>
<tr>
<th class="ctOdd">Default shortcut
</th></tr>
<tr>
<td class="ctEven"><i>None</i>
</td></tr>
<tr>
<th class="ctOdd">See also
</th></tr>
<tr>
<td class="ctEven"><i>None</i>
</td></tr>
<tr>
<th class="ctOdd">
</th></tr>
<tr>
<td class="ctToc"><br/><div aria-labelledby="mw-toc-heading" class="toc" id="toc" role="navigation"><input class="toctogglecheckbox" id="toctogglecheckbox" role="button" style="display:none" type="checkbox"/><div class="toctitle" dir="ltr" lang="en"><h2 id="mw-toc-heading">Contents</h2><span class="toctogglespan"><label class="toctogglelabel" for="toctogglecheckbox"></label></span></div>
<ul>
<li class="toclevel-1 tocsection-1"><a href="#Description"><span class="tocnumber">1</span> <span class="toctext">Description</span></a>
<ul>
<li class="toclevel-2 tocsection-2"><a href="#Principle_of_smoothing"><span class="tocnumber">1.1</span> <span class="toctext">Principle of smoothing</span></a></li>
<li class="toclevel-2 tocsection-3"><a href="#Launching_other_programs_or_commands"><span class="tocnumber">1.2</span> <span class="toctext">Launching other programs or commands</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-4"><a href="#Setup"><span class="tocnumber">2</span> <span class="toctext">Setup</span></a></li>
<li class="toclevel-1 tocsection-5"><a href="#Usage"><span class="tocnumber">3</span> <span class="toctext">Usage</span></a></li>
<li class="toclevel-1 tocsection-6"><a href="#Links"><span class="tocnumber">4</span> <span class="toctext">Links</span></a></li>
<li class="toclevel-1 tocsection-7"><a href="#Credits"><span class="tocnumber">5</span> <span class="toctext">Credits</span></a></li>
<li class="toclevel-1 tocsection-8"><a href="#Script"><span class="tocnumber">6</span> <span class="toctext">Script</span></a>
<ul>
<li class="toclevel-2 tocsection-9"><a href="#Code"><span class="tocnumber">6.1</span> <span class="toctext">Code</span></a></li>
</ul>
</li>
</ul>
</div>
</td></tr>
</tbody></table>
</div>
<div class="mw-content-ltr" dir="ltr" lang="en">
<h2><span class="mw-headline" id="Description">Description</span></h2>
</div>
<div class="mw-content-ltr" dir="ltr" lang="en">
<p>This macro creates an stl file with perfect rounding, i.e. without visible facets, from selected parts. It also allows to launch programs of your choice. For example to automate the FreeCAD → Slicer → printing workflow.
</p>
</div>
<div class="mw-content-ltr" dir="ltr" lang="en">
<p>After the creation of the stl file you can, for example, open your slicer with the stl file, switch on your printer, heat the printer bed and, if necessary, trigger additional commands in your home automation.
</p>
</div>
<p><span class="mw-default-size" typeof="mw:File"><a class="mw-file-description" href="../File/Macro_3D_Printer_Workflow_Dialog.png"><img decoding="async" height="216" src="../File/Macro_3D_Printer_Workflow_Dialog.png" width="402"/></a></span>
</p>
<div class="mw-content-ltr" dir="ltr" lang="en">
<h3><span class="mw-headline" id="Principle_of_smoothing">Principle of smoothing</span></h3>
</div>
<p><span class="mw-default-size" typeof="mw:File"><a class="mw-file-description" href="../File/Macro_3D_Printer_Workflow_With_Facets.png"><img decoding="async" height="363" src="../File/Macro_3D_Printer_Workflow_With_Facets.png" width="550"/></a></span>
</p>
<div class="mw-content-ltr" dir="ltr" lang="en">
<p style="text-align:left; font-style:italic; width:800px; margin-left:1em; margin-right:1em;">With visible facets</p>
</div>
<p><span class="mw-default-size" typeof="mw:File"><a class="mw-file-description" href="../File/Macro_3D_Printer_Workflow_Without_Facets.png"><img decoding="async" height="438" src="../File/Macro_3D_Printer_Workflow_Without_Facets.png" width="516"/></a></span>
</p>
<div class="mw-content-ltr" dir="ltr" lang="en">
<p style="text-align:left; font-style:italic; width:800px; margin-left:1em; margin-right:1em;">Without visible facets</p>
</div>
<div class="mw-content-ltr" dir="ltr" lang="en">
<p>The macro modifies the deviation property of the solids before creating the stl file and restores the original values afterwards. Next it can launch the stl file which will open for example under Cura, if the stl extension has been associated with that program on your operating system.
</p>
</div>
<div class="mw-content-ltr" dir="ltr" lang="en">
<h3><span class="mw-headline" id="Launching_other_programs_or_commands">Launching other programs or commands</span></h3>
</div>
<div class="mw-content-ltr" dir="ltr" lang="en">
<p>The macro can launch additional programs or commands that you might enter in a terminal:
</p>
<ul><li>Turn on the printer and the light (requires a computer controlled socket).</li>
<li>Connect Octoprint to the printer.</li>
<li>Start preheating the printer bed.</li>
<li>Save your FreeCAD and stl file somewhere.</li></ul>
</div>
<div class="mw-content-ltr" dir="ltr" lang="en">
<h2><span class="mw-headline" id="Setup">Setup</span></h2>
</div>
<div class="mw-content-ltr" dir="ltr" lang="en">
<p>Check that the stl extension is associated with your slicer on your operating system. In other words, when you double-click an stl file your slicer should open and load your stl file.
</p>
</div>
<div class="mw-content-ltr" dir="ltr" lang="en">
<p>If you run the macro as it is, it will just create the stl without visible facets, but no others programs will be launched. For that you have to edit the lines of code that come after <code>commands=[</code> in the section <i>Parameters that can be changed</i>. Have a look at the comments in the <a href="#Code">Code</a>.
</p>
</div>
<div class="mw-content-ltr" dir="ltr" lang="en">
<h2><span class="mw-headline" id="Usage">Usage</span></h2>
</div>
<div class="mw-content-ltr" dir="ltr" lang="en">
<ol><li>Select one or more solid objects to print.</li>
<li>Start the macro.</li>
<li>The dialog opens:<br/><span class="mw-default-size" typeof="mw:File"><a class="mw-file-description" href="../File/Macro_3D_Printer_Workflow_Dialog.png"><img decoding="async" height="216" src="../File/Macro_3D_Printer_Workflow_Dialog.png" width="402"/></a></span></li>
<li>Check the desired options in the left column.</li>
<li>Enter the <b>Accuracy (param deviation)</b>:
<ul><li>0.5 is the default value in FreeCAD.</li>
<li>0.05 allows a stronger smoothing.</li>
<li>0.01 is perfect from a smoothing point of view.</li></ul></li>
<li>Press the <span style="background: #f5f5f5; -moz-box-shadow: 0.1em 0.1em 0.2em rgba(0,0,0,0.1); -webkit-box-shadow: 0.1em 0.1em 0.2em rgba(0,0,0,0.1); box-shadow: 0.1em 0.1em 0.2em rgba(0,0,0,0.1); border: 2px solid #989898; border-radius: 0.4em; padding: 0px 10px 1px 10px; font-weight:normal;">OK</span> button.</li></ol>
</div>
<div class="mw-content-ltr" dir="ltr" lang="en">
<p>The lower the deviation, the better the quality, but the larger the size of the stl file. The value must be between 0 and 1
</p>
</div>
<div class="mw-content-ltr" dir="ltr" lang="en">
<h2><span class="mw-headline" id="Links">Links</span></h2>
</div>
<div class="mw-content-ltr" dir="ltr" lang="en">
<ul><li><a class="external text" href="https://forum.freecadweb.org/viewtopic.php?f=12&amp;t=52138" rel="nofollow">Forum discussion (French)</a></li>
<li><a href="../Macros_recipes.html" title="Macros recipes">Macros recipes</a></li>
<li><a href="../How_to_install_macros.html" title="How to install macros">How to install macros</a></li>
<li><a href="../Customize_Toolbars.html" title="Customize Toolbars">How to customize toolbars</a></li></ul>
</div>
<div class="mw-content-ltr" dir="ltr" lang="en">
<h2><span class="mw-headline" id="Credits">Credits</span></h2>
</div>
<div class="mw-content-ltr" dir="ltr" lang="en">
<p>Thanks to openBrain for the help on the code. Very good teacher!<br/>
Thanks to Mario 52, David69 and Roy_043 for the help on this wiki.
</p>
</div>
<div class="mw-content-ltr" dir="ltr" lang="en">
<h2><span class="mw-headline" id="Script">Script</span></h2>
</div>
<div class="mw-content-ltr" dir="ltr" lang="en">
<p>ToolBar Icon <span class="mw-default-size" typeof="mw:File"><a class="mw-file-description" href="../File/Macro_3D_Printer_Workflow.png"><img decoding="async" height="64" src="../File/Macro_3D_Printer_Workflow.png" width="64"/></a></span>
</p>
</div>
<div class="mw-content-ltr" dir="ltr" lang="en">
<h3><span class="mw-headline" id="Code">Code</span></h3>
</div>
<p>ver 00.02 05/02/2023 by 2cv001 <b>3D_Printer_Workflow.FCMacro</b>
</p>
<pre>#!/usr/bin/env python
# -*- coding: utf-8 -*-
# ==================================================================
# ==================================================================
# ==                                                              ==
# ==  Workflow to print with "stl" file with perfect rounding     ==
# ==  and launch others programs                                  ==
# ==                                                              ==
# ==================================================================
# ==================================================================
__author__ = "2cv001"
__title__   = "Macro_3D_Printer_Workflow"
__date__    = "2023/02/05"    #YYYY/MM/DD
__version__ = __date__
__icon__    = "https://wiki.freecadweb.org/images/b/b4/Macro_3D_Printer_Workflow.png"
__Wiki__    = "http://www.freecadweb.org/wiki/Macro_3D_Printer_Workflow"
"""
Macro that creates an "stl" file with perfect rounding
= without visible facets.
It also allows to launch programs of your choice
For example to automate the FreeCAD -&gt; Slicer -&gt; printing workflow

Principle of smoothing : it modifies the deviation property of the solids before
generation of the stl and then replace the old values
At the end, it proposes to launch the stl file which will open for example under
cura if the stl extension has been associated with cura in your operating system.

Launching other programs or commands :
You can ask it to chain any program or command that you might
type in a terminal.
To do this, you must change what is in the
"parameters that can be changed" section.

Examples of applications:
- Turn on the printer and the light (requires for example a controlled socket)
- Connect octoprint to the printer
- Start the tray preheating
- Save your FreeCAD and stl file
....


Tested on windows and Linux
"""
import FreeCAD as App
import Mesh
from PySide2 import QtCore, QtWidgets
import os, sys, subprocess
import time
import FreeCADGui as Gui

#================================
# Parameters that can be changed
#================================

# Smoothing management
#--------------------

# deviation : default value that will be displayed in the dialog box.
# 0.5 is the default value in FreeCad, 0.05 allows a stronger smoothing.
# 0.01 is perfect from a smoothing point of view.
# The lower the value, the better the quality,
# but the larger the size of the stl file
# the value must be between 0 and 1
deviation=0.01
doitLancerFichier=True # if True, it will be proposed to launch the stl file.
                                 # otherwise put False

# Automatic program launch,
# Automation of the production line
#------------------------------------------

delaiMax=10 # if the user enters a delay greater than this value,
                   # it will be reduced to delaiMax

#To launch programs of your choice
#------------------------------------------
#Typically for example a home automation program, 
#turn on your printer or/and a light etc.
#Use the following syntax by adding after the line "# insert your lines here" a line
#   with this syntax (important: align the [ with the others):
#  [ ['command to execute', 'param 1', param 2, ] ,'.extension','question to ask', waiting time],
# Details of the syntax :
#  'command to execute' : the command you want to execute. 
#  'param 1, param 2,...' : if your program needs parameters. 
#      These parameters will be taken into account only if extension=''.#
#  'extension': if not empty then the first parameter will be replaced by the name of 
#      your FreeCAD file but with this extension.
#  'question to ask': the question to display in the dialog box
#  time_wait : optional : nb of seconds to wait after execution
#      allows for example to wait for the printer to start before asking it to heat the plate

#  Note in the examples below the double \ in place of \ (because the special characters
#    must be preceded by an \ in python). Ditto for the apostrophe for example
#  the lines in question are to be inserted further down after commands=[...
#
# Examples of possible launches:

"""
Launching a program :
----------------------
  to launche a program without parameter
[ ['calc.exe'                                         ] ,''    ,'Launch the calculator ?'],
  to launche a program with a parameter (here : dessin.jpg)
[ ['C:\\WINDOWS\\system32\\mspaint.exe','dessin.jpg'  ] ,''    ,'Launch  Paint ?'          ],
  to launche a program with an extension parameter. If for example, 
  the freecad project file name is 'mondessin.FCStd'
  and if you give '.stl' as extension, the program will be launched with as first parameter 'mondessin.stl'
  Here cura will be launched with the file 'modessin.stl' loaded : 
[ ['C:\\Program Files\\Ultimaker Cura 4.8.0\\Cura.exe'] ,'.stl','Launch  Cura ?'           ],
  to load an url in firefox. Here, to launch octopi in firefox.
[ ['C:\\Program Files\\Mozilla Firefox\\firefox.exe','https://octopi.local'],'','Launch Octoprint ?'],
    On linux:
[ [   'firefox','https://octopi.local'                ] , ''   ,'Launch Octoprint ?'      ], 

Launching a web page (here, a php script) :
-----------------------------------------
[ ['curl','http://pidomotique/connecte.php'           ] , ''   ,'Connect the printer ?'],
Launching an url using https but insecure
[ ['curl','https://pidomotique/connecte.php,'--insecure'] , ''   ,'Connect the printer ?'],
And if we want a delay of 10 seconds before the following program is executed: :
[ ['curl','https://pidomotique/connecte.php,'--insecure'] , ''   ,'Connect the printer ?',10],
Example of printer control via octoprint (f you have it...): 
   send a G-code (see https://marlinfw.org/meta/gcode/ for others G-codes)
   here : temperature setting of the plate 
- Replace the XXX after X-Api-Key: by your API key (found in the octoprint parameters)
- Replace http://octopi.local by the url with which you access octoprint
- Change the value 050 in "M140 S050". S050 indicates that you need to heat to 50°.
     if you want 60°, replace S050 by S060
- 2 lines to copy after having adapted it:
  [  [  'curl','-H', 'Content-Type: application/json','-H', 'X-Api-Key: XXXXXXXXXXXXXXXXXXXXX', '-X', 'POST',
            '-d {"command":"M140 S050"}','http://octopi.local/api/printer/command' ] , '','Warm up the printer plate ?' ],


"""


commandes=[
# insert your lines here.
#  [ ['calc.exe'                                         ] ,''    ,'Lancer la calculatrice ?',2],
#  [ ['C:\\Program Files\\Ultimaker Cura 5.2.1\\Ultimaker-Cura.exe'] ,'.stl','Lancer Cura ?'           ],
#  [  ['curl','http://pidomotique/connecte.php'              ] , ''   ,'Allumer et connecter l\'imprimante ?',4],
#  [  [  'curl','-H', 'Content-Type: application/json','-H', 'X-Api-Key: XXXXXXXXXXXXXXXXXXXXX', '-X', 'POST',
#            '-d {"command":"M140 S050"}','http://octopi.local/api/printer/command' ] , '','Warm up the printer plate ?' ],
# 2 jeedom command that I use. Put a # at the begining of the 2 lines.
  [  ['curl', 'https://pijeedom/core/api/jeeApi.php?apikey=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&amp;type=cmd&amp;id=4042','--insecure' ] , ''   ,'Turn on and connect printer ?',10],
  [  ['curl','https://pijeedom/core/api/jeeApi.php?apikey=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&amp;type=cmd&amp;id=4048','--insecure'  ] , ''   ,'Heat the bed ?'],
  [  ['C:\\Program Files\\Mozilla Firefox\\firefox.exe','https://octopi'],'','Launch Octoprint ?'],



           ]


#===============
#Initialisations
#===============
dictionnaireOrigineDeviation={}
mw = Gui.getMainWindow()
indiceCommandeEtParam=0
indiceExtFileNameParamCommandeALancer=1
indiceTextAutreCommandeALancer=2
indiceDelai=3

# UI Class definitions
class BoiteDialogueSTLGuiClass(QtWidgets.QDialog):

    def  __init__(self, parent=None):
        super(BoiteDialogueSTLGuiClass, self).__init__(parent)
        self.initUI()

    def initUI(self):
        self.tabCheckboxTextCommandes=[] # table of checkbox commands to run
        self.setGeometry( 250, 250, 400, 150)
        self.setWindowTitle("Export and launch software")
        lay = QtWidgets.QGridLayout(self)

        # checkboxs
        self.checkboxGenererSTL = QtWidgets.QCheckBox("Generate STL ?", self)
        self.checkboxGenererSTL.setCheckState(QtCore.Qt.Checked)
        lay.addWidget(self.checkboxGenererSTL, 0, 0)
        if doitLancerFichier :
            self.checkboxLancerSTL = QtWidgets.QCheckBox("Launch the slicer ?", self)
            self.checkboxLancerSTL.setCheckState(QtCore.Qt.Checked)
            lay.addWidget(self.checkboxLancerSTL, 2, 0)

        for posLigne, cmd in enumerate(commandes, start=3):
           textCommande=cmd[indiceTextAutreCommandeALancer]
           self.checkboxTextCommande = QtWidgets.QCheckBox(textCommande, self)
           # storing this checkbox in a table :
           self.tabCheckboxTextCommandes.append(self.checkboxTextCommande)
           self.checkboxTextCommande.setCheckState(QtCore.Qt.Checked)
           lay.addWidget(self.checkboxTextCommande, posLigne, 0)

        # numeric input field
        self.label2 = QtWidgets.QLabel('Accuracy (param deviation)\nbetween 0.01 and 1\n' +
            '0.01 for high quality', self)
        lay.addWidget(self.label2, 0, 1)

        self.precision = QtWidgets.QDoubleSpinBox(self)
        self.precision.setValue(deviation)
        self.precision.setRange(0.01,1)
        self.precision.setSingleStep(0.01)
        self.precision.setToolTip('The larger the number, the larger the file size\n' +
            'and the better the accuracy.\n' +
            'See the deviation parameter in FreeCAD')
        lay.addWidget(self.precision, 0, 2)

        butBox = QtWidgets.QDialogButtonBox(self)
        butBox.setOrientation(QtCore.Qt.Horizontal)
        butBox.setStandardButtons(QtWidgets.QDialogButtonBox.Cancel | QtWidgets.QDialogButtonBox.Ok)
        lay.addWidget(butBox)
        butBox.accepted.connect(self.accept)
        butBox.rejected.connect(self.reject)

        self.setLayout(lay)


#===============
#functions
#===============
def octopi(api,commande,urlOctopi,apiKey) :
    """
    Function that returns the parameter to pass to subprocess.Popen if you 
    want to run an octopi API. Not used here. But for memory purposes 
    and a future evolution

    Arguments :
        api : the api to run ex: '/api/printer/command'
        commande : the command of the API in question ex: '{"command": "M140 S050"}'
        urlOctoprint : the url of your octopi ex : 'https://octopi.local'
        apiKey : the API key you find in setting/API of octoprint
    Returns :

   Example
       API running a gcode. Here the heating of the printer plate
       subprocess.Popen(
                          octopi(
                                '/api/printer/command',
                                '{"command":"M140 S050"}',
                                'https://octopi.local',
                                'XXXXKEYXAPIXXXXXXXX'))
                 ,close_fds=True)
    """
    commandeCurl=[
    'curl','-H', 'Content-Type: application/json','-H',
         'X-Api-Key: '+apiKey,
         '-X', 'POST',
        '-d '+commande,urlOctopi+api
    ]
    return commandeCurl


def nameFileStl(dictionnaireOrigineDeviation,mw=Gui.getMainWindow()):
    """
    Function that determines and returns the file name including path
    where the stl will be saved
    The FreeCAD document containing the dictionary objects must be
    opened and saved

    Arguments :
        dictionaryOrigineDeviation (dictionary) :
            a dictionary whose keys are FreeCAD solids.
            the filename will be obtained from the filename of the
            of the document containing the first object (solid) of this
            dictionary

    Returns :
        '' if the document does not exist,
        otherwise the name of the file where the stl will be saved

    Example
    """

    doc=list(dictionnaireOrigineDeviation.keys())[0].Document
    if doc is None:
        QtWidgets.QMessageBox.information(mw,'Warning',\
            "You do not have a document open")
        return ''
    if doc.FileName=='':
        QtWidgets.QMessageBox.information(mw,
             'Warning','Save your document before restarting the order')
        return ''
    return(os.path.splitext(doc.FileName)[0]+'.stl')

def memoriseObjEtDeviation(selection,deviationImpose):
    """
    Memorises the solids that are contained in selection and their
    deviation property and replaces it with the value
    of deviationImpose
    It imposes a subsequent recompute by a touch.
    Recompute() must eventually be run after

    Arguments :
        selection: a selection of objects
deviationImpose (float): value that we want to impose to deviation.

    Returns:
        a dictionary containing the object in key and the deviation in value
        Returns {} if there is no suitable object in the selection

    Example:
        memoriseObjEtDeviation(Gui.Selection.getSelection(),deviation)
    """
    dicoObjDeviation={}
    for objData in selection :
        if objData.isDerivedFrom('Part::Feature') \
          and not objData.isDerivedFrom('PartDesign::Feature')\
          and not objData.isDerivedFrom('Part::Part2DObject'):
            dicoObjDeviation[objData]=objData.ViewObject.Deviation
            objData.ViewObject.Deviation=deviationImpose
           # pour imposer un recompute même si la déviation est plus petite
           # qu'avant :
            objData.touch()
            for o in objData.ViewObject.claimChildren():
                    o.touch()
    return dicoObjDeviation

def restitueDeviation(dicoOrigineDeviation):
    """
 Function that replaces the deviation property in the objects
    It imposes a recompute by a touch. recompute() must be
    run after

    Arguments:
        dicoOrigineDeviation a dictionary containing the object in key
        and the value to be imposed in the deviation property of the object
        in value

    Returns: Does not return anything

    Example:
        restitueDeviation(dicoOrigineDeviation)

    """
    for ob2 in dicoOrigineDeviation:
        ob2.ViewObject.Deviation=dicoOrigineDeviation[ob2]
        # to impose a recompute even if the deviation is smaller
        # than before:
        ob2.touch()
        for o in ob2.ViewObject.claimChildren():
            o.touch()

def openFile(fileName):
    """
 function that launches a file depending on the operating system
    checked for now only under windows

    Arguments:
        fileName (string) the name of the file to run

    Returns
        Does not return anything

    Example:
        openFile(unfichier.stl)
        openFile(calc.exe)
    """
    if sys.platform == "win32":
        os.startfile(fileName)
    else:
        opener ="open" if sys.platform == "darwin" else "xdg-open"
        subprocess.Popen([opener, fileName],close_fds=True)

def recalcul(dicoObjs):
    """
    launches a recompute for each Document of the dico objects
    only if it has not already been done
    Arguments:
        dicoObjs a dictionary containing the object in key

    Returns
        Does not return anything

    Example:
        recalcul(dicoMesObjets)
    """
    docDejaRecalcul=[]
    for obj in dicoObjs:
        if obj.Document not in docDejaRecalcul:
            obj.Document.recompute()
            docDejaRecalcul.append(obj.Document)

def lanceCommmandes(commandesAlancer,fileStlName,formBoiteDialogueSTL):
    """
    launch the orders
    Arguments:
        commandesAlancer in the form of an array of arrays
        [ ['command to execute', 'param 1', param 2, ] ,'.extention','question to ask',delay ],
          ['command to execute', 'param 1', param 2, ] ,'.extention','question to ask',delay ],
          ...
        ]
         'command to execute' : the command you want to execute.
         For example 'myProgram.exe' if need, put also its path.
         param 1, param2... ' : if your program needs parameters.
            Will only be taken into account if extention=''.
         'extention': if not empty, parameter param 1 will be the name of your
              FreeCAD file but with your extension :
         question to ask': the question to display in the dialog box
         delay: waiting time in seconds before going to the next command.

    Returns
         Do not return anything

    Example:
        lanceCommmandes(commandes,fileStlName,formBoiteDialogueSTL) # runs the commands described in commands
    """

    for tbktc in formBoiteDialogueSTL.tabCheckboxTextCommandes :
        if tbktc.isChecked() :
            i= formBoiteDialogueSTL.tabCheckboxTextCommandes.index(tbktc)
            commande=commandesAlancer[i]
            commandeEtParam=commande[indiceCommandeEtParam]
            extFileNameParamCommandeALancer=commande[indiceExtFileNameParamCommandeALancer]
            textAutreCommandeALancer=commande[indiceTextAutreCommandeALancer]
            delai=0
            try :
               if commande[indiceDelai:indiceDelai+1]!=[] : #if the user has entered a delay
                  delai=commande[indiceDelai]
            except :
               print ('Delay not taken into account because of invalid numerical value'+
                      'for the command '+ textAutreCommandeALancer)
            if delai &gt; delaiMax :
                delai=delaiMax

            if extFileNameParamCommandeALancer!='':
                if commandeEtParam[2:3]==[]  : # There is no parameter.
                   # We add a parameter to put our file name
                   # with our extension.
                   commandeEtParam.append('')
                commandeEtParam[1]=   os.path.splitext(fileStlName)[0]+  extFileNameParamCommandeALancer
            subprocess.Popen(commandeEtParam,close_fds=True)
            print(commandeEtParam)
            time.sleep(delai)# Pause time (seconds)


def run(objs=Gui.Selection.getSelection(), dev=deviation):
    """
    main function
    Arguments:
        doc: the active document
        objs : the objects that have been selected beforehand
        dev : the value of the deviation property which will be
              imposed before the generation of the stl

    Returns
        Returns nothing

    Example:
        run()
    """

   #check if at least one solid (body and similar) has been selected
    nbBody=0
    for objData in objs :
        if objData.isDerivedFrom('Part::Feature') \
          and not objData.isDerivedFrom('PartDesign::Feature')\
          and not objData.isDerivedFrom('Part::Part2DObject'):
          nbBody=nbBody+1

    if nbBody==0: #  if we haven't found any solids, we have to have an active one
         try:
            objs=[]
            objs.append(Gui.ActiveDocument.ActiveView.getActiveObject('pdbody'))
            response=QtWidgets.QMessageBox.information(mw, 'Warning',\
            '-You did not select a solid. Automatic solid selection : '+objs[0].Label +
            ' by the macro..\n-If not adequate, select one or more solids before running the macro',
                  QtWidgets.QMessageBox.Ok | QtWidgets.QMessageBox.Cancel )
            if response==QtWidgets.QMessageBox.Cancel :
              return
         except :
            QtWidgets.QMessageBox.information(mw, 'Warning',\
            '--Select one or more solids before running the macro')
            return

# Dialog box of what we want to do
    formBoiteDialogueSTL=BoiteDialogueSTLGuiClass(mw)
    if not formBoiteDialogueSTL.exec_() :
        return
    dev=formBoiteDialogueSTL.precision.value()
    # we memorize the selected solids and their deviation,
    # we make a touch() of their child to be taken into account in recompute :
    dictionnaireOrigineDeviation=memoriseObjEtDeviation(objs,dev)
    if len(dictionnaireOrigineDeviation)==0: # if no solids were found
        QtWidgets.QMessageBox.information(mw, 'Warning',\
            '-Select one or more solids before running the macro')
        return
    # we get the name of the file where we have to save the stl
    fileStlName=nameFileStl(dictionnaireOrigineDeviation)
    if fileStlName == '' :
        return
    #The solids in dictionaryOriginDeviation are passed as parameters
    if formBoiteDialogueSTL.checkboxGenererSTL.isChecked():
       Mesh.export(list(dictionnaireOrigineDeviation.keys()), fileStlName)
       print('Export done')
    # restitution of the original property deviation for all solids :
    restitueDeviation(dictionnaireOrigineDeviation)
    recalcul(dictionnaireOrigineDeviation)

    if formBoiteDialogueSTL.checkboxLancerSTL.isChecked():
            #runs for example cura if cura has been associated with *.stl files
            openFile(fileStlName)

    lanceCommmandes(commandes,fileStlName,formBoiteDialogueSTL)
            # runs the commands described in commands


if __name__ == '__main__':
    run()
</pre>
<!-- 
NewPP limit report
Cached time: 20241214203948
Cache expiry: 86400
Reduced expiry: false
Complications: [show‐toc, no‐toc‐conversion]
CPU time usage: 0.049 seconds
Real time usage: 0.079 seconds
Preprocessor visited node count: 162/1000000
Post‐expand include size: 3195/2097152 bytes
Template argument size: 912/2097152 bytes
Highest expansion depth: 7/100
Expensive parser function count: 2/100
Unstrip recursion depth: 0/20
Unstrip post‐expand size: 21522/5000000 bytes
-->
<!--
Transclusion expansion time report (%,ms,calls,template)
100.00%    3.837      1 -total
 63.74%    2.446      1 Template:Macro
 18.79%    0.721      2 Template:Caption
 12.64%    0.485      1 Template:Button
-->
<!-- Saved in parser cache with key freecadweb_db01-wiki_:pcache:idhash:305357-0!canonical and timestamp 20241214203948 and revision id 1228310. Rendering was triggered because: api-parse
 -->
</div></div><script src="../script.js"></script>
