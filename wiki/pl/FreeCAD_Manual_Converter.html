<link href="../site.css" rel="stylesheet" type="text/css"/><div class="mw-page-container"><h1 id="firstHeading" class="firstHeading mw-first-heading"><span class="mw-page-title-main">FreeCAD Manual Converter/pl</span></h1><?xml encoding="UTF-8"><div class="mw-parser-output"><div class="mw-pt-languages noprint" lang="en" dir="ltr"><div class="mw-pt-languages-label">Other languages:</div><ul class="mw-pt-languages-list"><li><a href="../FreeCAD_Manual_Converter.html" class="mw-pt-languages-ui mw-pt-progress mw-pt-progress--complete" title="FreeCAD Manual Converter (100% translated)" lang="en" dir="ltr">English</a></li>
<li><span class="mw-pt-languages-selected mw-pt-progress mw-pt-progress--complete" lang="pl" dir="ltr">polski</span></li></ul></div>
<table class="fcinfobox wikitable ct" width="100%" style="float: right; width: 230px; margin-left: 10px;">
<tbody><tr>
<td class="ctTitle" style="font-weight: bold; font-size: 125%;">
<p><span typeof="mw:File"><a href="../File/Text-x-python.png" class="mw-file-description" title="Generic macro icon. Create your personal icon with the same name of the macro"><img alt="Generic macro icon. Create your personal icon with the same name of the macro" src="../File/Text-x-python.png" decoding="async" width="32" height="32"></a></span><span> </span>
Makrodefinicja: Konwerter Podr&#281;cznika FreeCAD
</p>
</td></tr>
<tr>
<th class="ctOdd">Opis
</th></tr>
<tr>
<td class="ctEven left macro-description">Skrypt Pythona, kt&oacute;ry automatycznie generuje wersje PDF i EPUB Podr&#281;cznika FreeCAD.<br><br>Macro version: 0.1<br>Last modified: 2024-12-16<br>FreeCAD version: Wszystkie<br>Autor: Adrianos<br>
</td></tr>
<tr>
<th class="ctOdd">Autor
</th></tr>
<tr>
<td class="ctEven macro-author"><a href="../index.php?title=User;Adrianos&amp;action=edit&amp;redlink=1.html" class="new" title="User:Adrianos (page does not exist)">Adrianos</a>
</td></tr>
<tr>
<th class="ctOdd">Do pobrania
</th></tr>
<tr>
<td class="ctEven macro-download"><i>Nie okre&#347;lono</i>
</td></tr>
<tr>
<th class="ctOdd">Odno&#347;niki
</th></tr>
<tr>
<td class="ctEven macro-Links"><a href="../pl/Macros_recipes.html" title="Macros recipes/pl">Przepisy na makropolecenia</a><br><a href="../pl/How_to_install_macros.html" title="How to install macros/pl">Jak zainstalowa&#263; makrodefinicje</a><br><a href="../pl/Customize_Toolbars.html" title="Customize Toolbars/pl">Dostosowanie pask&oacute;w narz&#281;dzi</a>
</td></tr>
<tr>
<th class="ctOdd">Wersja Makrodefinicji
</th></tr>
<tr>
<td class="ctEven macro-version">0.1
</td></tr>
<tr>
<th class="ctOdd">Data zmian
</th></tr>
<tr>
<td class="ctEven macro-date">2024-12-16
</td></tr>
<tr>
<th class="ctOdd">Wersja FreeCAD
</th></tr>
<tr>
<td class="ctEven FreeCAD-version">Wszystkie
</td></tr>
<tr>
<th class="ctOdd">Domy&#347;lny skr&oacute;t
</th></tr>
<tr>
<td class="ctEven"><i>Brak</i>
</td></tr>
<tr>
<th class="ctOdd">Zobacz r&oacute;wnie&#380;
</th></tr>
<tr>
<td class="ctEven"><i>-</i>
</td></tr>
<tr>
<th class="ctOdd">
</th></tr>
<tr>
<td class="ctToc"><br><div id="toc" class="toc" role="navigation" aria-labelledby="mw-toc-heading"><input type="checkbox" role="button" id="toctogglecheckbox" class="toctogglecheckbox" style="display:none"><div class="toctitle" lang="en" dir="ltr"><h2 id="mw-toc-heading">Contents</h2><span class="toctogglespan"><label class="toctogglelabel" for="toctogglecheckbox"></label></span></div>
<ul>
<li class="toclevel-1 tocsection-1"><a href="#Wprowadzenie"><span class="tocnumber">1</span> <span class="toctext">Wprowadzenie</span></a></li>
<li class="toclevel-1 tocsection-2"><a href="#Kontekst"><span class="tocnumber">2</span> <span class="toctext">Kontekst</span></a></li>
<li class="toclevel-1 tocsection-3"><a href="#Zale%C5%BCno%C5%9Bci"><span class="tocnumber">3</span> <span class="toctext">Zale&#380;no&#347;ci</span></a>
<ul>
<li class="toclevel-2 tocsection-4"><a href="#Windows"><span class="tocnumber">3.1</span> <span class="toctext">Windows</span></a></li>
<li class="toclevel-2 tocsection-5"><a href="#Linux_(Ubuntu/Debian)"><span class="tocnumber">3.2</span> <span class="toctext">Linux (Ubuntu/Debian)</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-6"><a href="#U%C5%BCycie"><span class="tocnumber">4</span> <span class="toctext">U&#380;ycie</span></a></li>
<li class="toclevel-1 tocsection-7"><a href="#Script"><span class="tocnumber">5</span> <span class="toctext">Script</span></a></li>
</ul>
</div>

</td></tr>
</tbody></table>
<p><span id="Introduction"></span>
</p>
<h2><span class="mw-headline" id="Wprowadzenie">Wprowadzenie</span></h2>
<p>Konwerter Podr&#281;cznika FreeCAD to skrypt Pythona, kt&oacute;ry automatycznie generuje wersje PDF i EPUB Podr&#281;cznika FreeCAD z dokumentacji Wiki. Tworzy kompletny, odpowiednio sformatowany podr&#281;cznik w wersji offline, kt&oacute;ry zawiera wszystkie rozdzia&#322;y, obrazki i formatowanie z wersji online.
</p><p><span id="Background"></span>
</p>
<h2><span class="mw-headline" id="Kontekst">Kontekst</span></h2>
<p><a href="../pl/Manual;Introduction.html" title="Manual:Introduction/pl">Podr&#281;cznik FreeCAD</a> to dokument, kt&oacute;ry stale ewoluuje dzi&#281;ki wk&#322;adowi cz&#322;onk&oacute;w spo&#322;eczno&#347;ci. Chocia&#380; jest dzi&#281;ki temu doskona&#322;ym i aktualnym &#378;r&oacute;d&#322;em, zdarza si&#281;, &#380;e u&#380;ytkownicy potrzebuj&#261; dost&#281;pu offline do podr&#281;cznika lub wol&#261; go czyta&#263; na czytnikach e-book&oacute;w i tabletach. Ten skrypt to umo&#380;liwia, pozwalaj&#261;c u&#380;ytkownikom na:
</p>
<ul><li>Generowanie aktualnej kopii offline podr&#281;cznika w dowolnej chwili</li>
<li>Tworzenie format&oacute;w PDF i EPUB dla r&oacute;&#380;nych preferencji</li>
<li>Zawieranie wszystkich ostatnich wk&#322;ad&oacute;w u&#380;ytkownik&oacute;w i aktualizacji</li>
<li>Utrzymywanie odpowiedniego formatowania i jako&#347;ci obrazk&oacute;w</li>
<li>Posiadanie kompletnego &#378;r&oacute;d&#322;a nawet bez dost&#281;pu do sieci</li></ul>
<p><span id="Dependencies"></span>
</p>
<h2><span id="Zale.C5.BCno.C5.9Bci"></span><span class="mw-headline" id="Zale&#380;no&#347;ci">Zale&#380;no&#347;ci</span></h2>
<h3><span class="mw-headline" id="Windows">Windows</span></h3>
<ol><li>Zainstaluj Python 3.x.</li>
<li>Zainstaluj GTK3 runtime</li>
<li>Otw&oacute;rz wiersz polece&#324; i zainstaluj pakiety Pythona:</li></ol>
<pre>pip install requests weasyprint beautifulsoup4 PyPDF2 Pillow cairosvg ebooklib</pre>
<h3><span id="Linux_.28Ubuntu.2FDebian.29"></span><span class="mw-headline" id="Linux_(Ubuntu/Debian)">Linux (Ubuntu/Debian)</span></h3>
<p>Zainstaluj wszystkie wymagane zale&#380;no&#347;ci, takie jak:
</p>
<div class="mw-highlight mw-highlight-lang-python mw-content-ltr" dir="ltr"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">update</span>
<span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="o">-</span><span class="n">y</span> <span class="n">python3</span><span class="o">-</span><span class="n">pip</span> <span class="n">python3</span><span class="o">-</span><span class="n">dev</span> <span class="n">python3</span><span class="o">-</span><span class="n">cairo</span> <span class="n">python3</span><span class="o">-</span><span class="n">gi</span><span class="o">-</span><span class="n">cairo</span>
<span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="o">-</span><span class="n">y</span> <span class="n">libcairo2</span><span class="o">-</span><span class="n">dev</span> <span class="n">libpango1</span><span class="mf">.0</span><span class="o">-</span><span class="n">dev</span> <span class="n">libgdk</span><span class="o">-</span><span class="n">pixbuf2</span><span class="mf">.0</span><span class="o">-</span><span class="n">dev</span> <span class="n">libffi</span><span class="o">-</span><span class="n">dev</span> <span class="n">shared</span><span class="o">-</span><span class="n">mime</span><span class="o">-</span><span class="n">info</span>
</pre></div>
<p>oraz
</p>
<div class="mw-highlight mw-highlight-lang-python mw-content-ltr" dir="ltr"><pre><span></span><span class="n">pip3</span> <span class="n">install</span> <span class="n">requests</span> <span class="n">weasyprint</span> <span class="n">beautifulsoup4</span> <span class="n">PyPDF2</span> <span class="n">Pillow</span> <span class="n">cairosvg</span> <span class="n">ebooklib</span>
</pre></div>
<p><span id="Usage"></span>
</p>
<h2><span id="U.C5.BCycie"></span><span class="mw-headline" id="U&#380;ycie">U&#380;ycie</span></h2>
<p>Aby u&#380;y&#263; skryptu, po prostu go pobierz i uruchom. Skrypt utworzy dwa pliki w bie&#380;&#261;cym katalogu:
</p>
<ul><li><b>FreeCAD_User_Manual.pdf</b>: Kompletna wersja PDF podr&#281;cznika</li>
<li><b>FreeCAD_User_Manual.epub</b>: Wersja EPUB odpowiednia dla czytnik&oacute;w e-book&oacute;w</li></ul>
<h2><span class="mw-headline" id="Script">Script</span></h2>
<pre>import requests
from weasyprint import HTML
import os
from bs4 import BeautifulSoup
import re
from PyPDF2 import PdfMerger
from PIL import Image
from io import BytesIO
import base64
import cairosvg
import ebooklib
from ebooklib import epub
import uuid
from datetime import datetime


class FreeCADManualConverter:
    def __init__(self):
        self.session = requests.Session()
        self.session.headers.update({
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36'
        })
        self.toc_entries = []  # Store chapter titles, subchapters, and hierarchy
        self.chapters_html = []  # Store HTML content for EPUB creation
        self.image_cache = {}  # Cache for deduplicating images

    def optimize_image(self, img_url, max_width=800):
        """Download and optimize a raster image."""
        try:
            response = self.session.get(img_url, stream=True)
            response.raise_for_status()
            img = Image.open(BytesIO(response.content))
            if img.width &gt; max_width:
                img = img.resize((max_width, int(img.height * max_width / img.width)), Image.Resampling.LANCZOS)
            buffer = BytesIO()
            img.save(buffer, format="PNG", optimize=True)
            buffer.seek(0)
            return buffer.read()
        except Exception as e:
            print(f"Error optimizing image {img_url}: {e}")
            return None

    def svg_to_png(self, svg_url):
        """Convert SVG to PNG."""
        try:
            response = self.session.get(svg_url)
            response.raise_for_status()
            return cairosvg.svg2png(bytestring=response.content, output_width=16, output_height=16)
        except Exception as e:
            print(f"Error converting SVG {svg_url} to PNG: {e}")
            return None
        self.session = requests.Session()
        self.session.headers.update({
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36'
        })
        self.toc_entries = []  # Store chapter titles, subchapters, and hierarchy
        self.chapters_html = []  # Store HTML content for EPUB creation

    def extract_manual_links(self, base_url="https://wiki.freecad.org/Manual"):
        """Extract all manual links and subchapters from the main Manual page."""
        print(f"Fetching manual links from {base_url}...")
        html_content = self.fetch_page(base_url)
        if not html_content:
            return []

        soup = BeautifulSoup(html_content, 'html.parser')
        links = {}
        seen = set()

        # Define unwanted languages
        excluded_languages = ['fr', 'de', 'es', 'hr', 'it', 'ko', 'pl', 'pt', 'ro', 'ru', 'zh']

        for a_tag in soup.find_all('a', href=True):
            href = a_tag['href']
            if any(f"/{lang}" in href for lang in excluded_languages):
                continue

            if href.startswith('/Manual:'):
                full_url = f"https://wiki.freecad.org{href}"
                base_chapter = full_url.split('#')[0]
                subchapter = full_url.split('#')[1] if '#' in full_url else None

                if base_chapter not in seen:
                    links[base_chapter] = []
                    seen.add(base_chapter)

                if subchapter:
                    links[base_chapter].append(subchapter)

        print(f"Found {len(links)} unique manual links with subchapters.")
        return links

    def fetch_page(self, url):
        """Fetch the HTML content of a given URL."""
        if url.startswith('/'):
            url = f"https://wiki.freecad.org{url}"

        try:
            response = self.session.get(url)
            if response.status_code&nbsp;!= 200:
                print(f"Failed to fetch {url}. HTTP status code: {response.status_code}")
                return None
            return response.text
        except Exception as e:
            print(f"Error fetching {url}: {e}")
            return None

    def extract_main_content(self, html_content, base_url, chapter_title, chapter_id, subchapters):
        """Extract content within the 'mw-parser-output' div, fix links, and process image paths."""
        soup = BeautifulSoup(html_content, 'html.parser')

        # Remove unwanted elements
        for class_name in ['mw-pt-languages noprint', 'docnav', 'NavFrame', 'manualtoc']:
            for element in soup.find_all(class_=class_name):
                element.decompose()

        main_content = soup.find('div', class_='mw-parser-output')
        if not main_content:
            print("Main content ('mw-parser-output') not found.")
            return None

        # Add chapter title as heading at the top if not present
        if not main_content.find('h1', id=chapter_id):
            heading_tag = soup.new_tag('h1', id=chapter_id)
            heading_tag.string = chapter_title
            main_content.insert(0, heading_tag)

        # Process images and store them for EPUB
        for img in main_content.find_all('img'):
            src = img.get('src')
            if src and src.startswith('/'):
                img_url = f"{base_url}{src}"
                img_filename = os.path.basename(src)

                if src.endswith('.svg'):
                    # Convert SVG to PNG
                    png_data = self.svg_to_png(img_url)
                    if png_data:
                        img_data = png_data
                        img_filename = f"{img_filename[:-4]}.png"
                else:
                    # Optimize raster image
                    img_data = self.optimize_image(img_url)

                if img_data:
                    # For PDF
                    img['src'] = f"data:image/png;base64,{base64.b64encode(img_data).decode('utf-8')}"
                    # For EPUB - store reference
                    img['epub_src'] = img_filename
                    img['epub_data'] = img_data

        # Fix links
        for link in main_content.find_all('a'):
            href = link.get('href')
            if href and href.startswith('/'):
                link['href'] = f"{base_url}{href}"

        # Store the HTML content for EPUB creation
        self.chapters_html.append({
            'title': chapter_title,
            'id': chapter_id,
            'content': main_content,
            'number': len(self.chapters_html) + 1
        })

        return str(main_content)

    def convert_to_pdf(self, url, chapter_number, chapter_id, subchapters, output_dir='pdfs'):
        print(f"Processing {url}...")
        os.makedirs(output_dir, exist_ok=True)

        html_content = self.fetch_page(url)
        if not html_content:
            return None

        soup = BeautifulSoup(html_content, 'html.parser')
        chapter_title = soup.title.string.split(" - ")[0] if soup.title else "Chapter"
        chapter_title = chapter_title.replace("Manual:", "").strip()

        base_url = "https://wiki.freecad.org"
        main_content = self.extract_main_content(html_content, base_url, chapter_title, chapter_id, subchapters)
        if not main_content:
            return None

        safe_title = re.sub(r'[&lt;&gt;:"/\\</pre>
<!-- 
NewPP limit report
Cached time: 20241217104827
Cache expiry: 86400
Reduced expiry: false
Complications: [show&#8208;toc, no&#8208;toc&#8208;conversion]
CPU time usage: 0.040 seconds
Real time usage: 0.042 seconds
Preprocessor visited node count: 139/1000000
Post&#8208;expand include size: 2528/2097152 bytes
Template argument size: 7941/2097152 bytes
Highest expansion depth: 7/100
Expensive parser function count: 4/100
Unstrip recursion depth: 0/20
Unstrip post&#8208;expand size: 9886/5000000 bytes
-->
<!--
Transclusion expansion time report (%,ms,calls,template)
100.00%    4.634      1 -total
 44.63%    2.068      1 Template:Macro/pl
 25.77%    1.194      2 Template:MacroCode
 24.02%    1.113      2 Template:Code
-->

<!-- Saved in parser cache with key freecadweb_db01-wiki_:pcache:idhash:366594-0!canonical and timestamp 20241217104827 and revision id 1520117. Rendering was triggered because: diff-page
 -->
</div>
</div><script src="../site.js"></script>