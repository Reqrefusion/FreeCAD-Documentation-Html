<link href="../site.css" rel="stylesheet" type="text/css"/>
<div class="mw-page-container"><h1 class="firstHeading mw-first-heading" id="firstHeading"><span class="mw-page-title-main">Macro SketchUnmap/pl</span></h1><div class="mw-parser-output"><div class="mw-pt-languages noprint" dir="ltr" lang="en"><div class="mw-pt-languages-label">Other languages:</div><ul class="mw-pt-languages-list"><li><a class="mw-pt-languages-ui mw-pt-progress mw-pt-progress--complete" dir="ltr" href="../Macro_SketchUnmap.html" lang="en" title="Macro SketchUnmap (100% translated)">English</a></li>
<li><a class="mw-pt-progress mw-pt-progress--complete" dir="ltr" href="../fr\Macro_SketchUnmap.html" lang="fr" title="Macro SketchUnmap (100% translated)">français</a></li>
<li><a class="mw-pt-progress mw-pt-progress--stub" dir="ltr" href="../it\Macro_SketchUnmap.html" lang="it" title="Macro SketchUnmap (4% translated)">italiano</a></li>
<li><span class="mw-pt-languages-selected mw-pt-progress mw-pt-progress--stub" dir="ltr" lang="pl">polski</span></li></ul></div>
<table class="fcinfobox wikitable ct" style="float: right; width: 230px; margin-left: 10px;" width="100%">
<tbody><tr>
<td class="ctTitle" style="font-weight: bold; font-size: 125%;">
<p><span typeof="mw:File"><a class="mw-file-description" href="../File/SketchUnmap.svg"><img decoding="async" height="32" src="../File/SketchUnmap.svg" width="32"/></a></span><span> </span>
SketchUnmap
</p>
</td></tr>
<tr>
<th class="ctOdd">Description
</th></tr>
<tr>
<td class="ctEven left macro-description">This macro resets a sketch placement to an absolute one, eventually creating a datum plane.<br/>This macro has been written mainly to circumvent Topological Naming Issue that can break a model when a sketch has been directly or indirectly attached to a face or any other topological item.<br/>
<p>To prevent breakage, macro shall be applied when the model is still right. It can't "repair" a broken model. If you just break your model, undo the last change(s) back to a good situation, apply the macro to the unstable sketch(es) then redo the previous operation.<br/><br/>Macro version: 0.6.2<br/>Last modified: 2019-06-14<br/>FreeCAD version: 0.17 and above<br/>Download: <a class="external text" href="https://wiki.freecad.org/images/3/34/SketchUnmap.svg" rel="nofollow">ToolBar Icon</a><br/>Author: OpenBrain<br/>
</p>
</td></tr>
<tr>
<th class="ctOdd">Author
</th></tr>
<tr>
<td class="ctEven macro-author"><a class="new" href="../index.php?title=User;OpenBrain&amp;action=edit&amp;redlink=1.html" title="User:OpenBrain (page does not exist)">OpenBrain</a>
</td></tr>
<tr>
<th class="ctOdd">Download
</th></tr>
<tr>
<td class="ctEven macro-download"><a class="external text" href="https://wiki.freecad.org/images/3/34/SketchUnmap.svg" rel="nofollow">ToolBar Icon</a>
</td></tr>
<tr>
<th class="ctOdd">Links
</th></tr>
<tr>
<td class="ctEven macro-Links"><a href="../Macros_recipes.html" title="Macros recipes">Macros recipes</a><br/><a href="../How_to_install_macros.html" title="How to install macros">How to install macros</a><br/><a href="../Customize_Toolbars.html" title="Customize Toolbars">How to customize toolbars</a>
</td></tr>
<tr>
<th class="ctOdd">Macro Version
</th></tr>
<tr>
<td class="ctEven macro-version">0.6.2
</td></tr>
<tr>
<th class="ctOdd">Date last modified
</th></tr>
<tr>
<td class="ctEven macro-date">2019-06-14
</td></tr>
<tr>
<th class="ctOdd">FreeCAD Version(s)
</th></tr>
<tr>
<td class="ctEven FreeCAD-version">0.17 and above
</td></tr>
<tr>
<th class="ctOdd">Default shortcut
</th></tr>
<tr>
<td class="ctEven"><i>None</i>
</td></tr>
<tr>
<th class="ctOdd">See also
</th></tr>
<tr>
<td class="ctEven"><i>None</i>
</td></tr>
<tr>
<th class="ctOdd">
</th></tr>
<tr>
<td class="ctToc"><br/><div aria-labelledby="mw-toc-heading" class="toc" id="toc" role="navigation"><input class="toctogglecheckbox" id="toctogglecheckbox" role="button" style="display:none" type="checkbox"/><div class="toctitle" dir="ltr" lang="en"><h2 id="mw-toc-heading">Contents</h2><span class="toctogglespan"><label class="toctogglelabel" for="toctogglecheckbox"></label></span></div>
<ul>
<li class="toclevel-1 tocsection-1"><a href="#Description"><span class="tocnumber">1</span> <span class="toctext">Description</span></a>
<ul>
<li class="toclevel-2 tocsection-2"><a href="#Context"><span class="tocnumber">1.1</span> <span class="toctext">Context</span></a></li>
<li class="toclevel-2 tocsection-3"><a href="#Usage"><span class="tocnumber">1.2</span> <span class="toctext">Usage</span></a></li>
<li class="toclevel-2 tocsection-4"><a href="#Installation"><span class="tocnumber">1.3</span> <span class="toctext">Installation</span></a></li>
<li class="toclevel-2 tocsection-5"><a href="#Details"><span class="tocnumber">1.4</span> <span class="toctext">Details</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-6"><a href="#Script"><span class="tocnumber">2</span> <span class="toctext">Script</span></a>
<ul>
<li class="toclevel-2 tocsection-7"><a href="#Limitations"><span class="tocnumber">2.1</span> <span class="toctext">Limitations</span></a></li>
<li class="toclevel-2 tocsection-8"><a href="#Forum_discussion"><span class="tocnumber">2.2</span> <span class="toctext">Forum discussion</span></a></li>
</ul>
</li>
</ul>
</div>
</td></tr>
</tbody></table>
<h2><span class="mw-headline" id="Description">Description</span></h2>
<h3><span class="mw-headline" id="Context">Context</span></h3>
<p>This macro has been written mainly to circumvent Topological Naming Issue that can break a model when a sketch has been directly or indirectly attached to a face or any other topological item.
To prevent breakage, macro shall be applied when the model is still right. It can't "repair" a broken model. If you just break your model, undo the last change(s) back to a good situation, apply the macro to the unstable sketch(es) then redo the previous operation.
</p>
<h3><span class="mw-headline" id="Usage">Usage</span></h3>
<p>Functionally, the macro will remove the current mapping of the sketch on which it is applied, then apply to it an absolute placement so it is immune to mapping support change.
</p><p>To do so, the macro will basically propose 3 options (if your sketch isn't in a PartDesign Body, only first option is available and will be applied automatically) :
</p>
<ul><li>"Raw" mode =&gt; the sketch placement is made absolute in the body referential, nothing more</li>
<li>"DP@Face mode" =&gt; a datum plane is created where the mapping face is, then the sketch is attached to it respecting its attachment offset</li>
<li>"DP@Sketch" mode =&gt; a datum place is created where the sketch is (including attachment offset), then the sketch is attached to its origin</li></ul>
<p>To use the macro, just select the target sketch (eg. in the tree view) then run the macro. That's it !
</p>
<h3><span class="mw-headline" id="Installation">Installation</span></h3>
<p>The macro is available through <a href="../Std_AddonMgr.html" title="Std AddonMgr">Addon Manager</a>.
Code is provided on this page for convenience in case user system doesn't have git-python. Though it should be up-to-date, latest release is always available at <a class="external text" href="https://github.com/FreeCAD/FreeCAD-macros/blob/master/Sketcher/SketchUnmap.FCMacro" rel="nofollow">FreeCAD-macro repository</a>
</p><p>For more detailed explanations, see the <a href="../How_to_install_macros.html" title="How to install macros">How to install macros</a> page.
</p>
<h3><span class="mw-headline" id="Details">Details</span></h3>
<p>For better understanding, below is an example :
Let's suppose a simple cube whose top (yellow) face has been drafted. A cylinder is created with a padded circle whose sketch has been mapped (Flat face) to the drafted face and offset to match needs (Attachment offset) :
</p><p><span class="mw-default-size" typeof="mw:File"><a class="mw-file-description" href="../File/Unmap_ex1.png"><img decoding="async" height="361" src="../File/Unmap_ex1.png" width="936"/></a></span>
</p><p>Now for some reason, you need to revert the pull direction of the draft (of course without the cylinder to move). Here is what basically happen :
</p><p><span class="mw-default-size" typeof="mw:File"><a class="mw-file-description" href="../File/Unmap_ex2.png"><img decoding="async" height="366" src="../File/Unmap_ex2.png" width="1024"/></a></span>
</p><p>The treeview shows an error, the 3D view isn't updated, and the circle sketch is floating in the middle of nowhere...
</p><p>Now comes the job of the macro (that you need to run before changing the reference face, when the sketch is still at its right place). Select the sketch and run it. If your sketch is in a body, a message box will ask to choose among the 3 different options (if your sketch is out of a body, it will automatically apply the 1st one) :
</p>
<ul><li>"Raw" mode</li>
<li>"DP@Face mode"</li>
<li>"DP@Sketch" mode</li></ul>
<p>Which in term of picture gives the following :
</p><p><span class="mw-default-size" typeof="mw:File"><a class="mw-file-description" href="../File/Unmap_macro.png"><img decoding="async" height="782" src="../File/Unmap_macro.png" width="669"/></a></span>
</p>
<h2><span class="mw-headline" id="Script">Script</span></h2>
<p>ToolBar Icon <span class="mw-default-size" typeof="mw:File"><a class="mw-file-description" href="../File/SketchUnmap.svg"><img decoding="async" height="64" src="../File/SketchUnmap.svg" width="64"/></a></span>
</p><p><b>Macro_SketchUnmap.FCMacro</b>
</p>
<pre>#!/usr/bin/python
#####################################
# Copyright (c) openBrain 2019
# Licensed under LGPL v2
#
# This FreeCAD macro will unmap a sketch from eg. a face and make its placement absolute in the body. It proposes 3 options (forcely the first if sketch not in a body) :
# * "Raw" mode =&gt; the sketch placement is made absolute in the body referential, nothing more
# * "DP@Face mode" =&gt; a datum plane is created where the mapping face is, then the sketch is attached to it respecting its attachment offset
# * "DP@Sketch" mode =&gt; a datum place is created where the sketch is (including attachment offset), then the sketch is attached to its origin
#
# Main use of the macro is to make design more robust to topological naming issue
#
# Version history :
# *0.6.2 : add icon (metadata)
# *0.6.1 : minor changes after PR review
# *0.6 : some typo improvement + commenting for official PR
# *0.5 : beta release
#
#####################################

__Name__ = 'SketchUnmap'
__Comment__ = 'Unmap a sketch &amp; makes its placement absolute"'
__Author__ = 'openBrain'
__Version__ = '0.6.2'
__Date__ = '2019-06-14'
__License__ = 'LGPL v2'
__Web__ = 'https://www.freecadweb.org/wiki/Macro_SketchUnmap'
__Wiki__ = 'https://www.freecadweb.org/wiki/Macro_SketchUnmap'
__Icon__ = 'https://wiki.freecad.org/images/3/34/SketchUnmap.svg'
__Help__ = 'Select the sketch to unmap (eg. in the tree view) then run the macro'
__Status__ = 'Beta'
__Requires__ = 'FreeCAD &gt;= 0.17'
__Communication__ = 'https://forum.freecadweb.org/viewtopic.php?f=22&amp;t=36078'
#    __Files__ = ''

__dbg__ = False  #True for debugging

from PySide import QtGui

def cslM(msg): #Print message in console
    FreeCAD.Console.PrintMessage('\n')
    FreeCAD.Console.PrintMessage(msg)

def cslW(msg): #Print warning in console
    FreeCAD.Console.PrintMessage('\n')
    FreeCAD.Console.PrintWarning(msg)

def cslE(msg): #Print error in console
    FreeCAD.Console.PrintMessage('\n')
    FreeCAD.Console.PrintError(msg)

def cslD(msg): #Print debug message in console
    if __dbg__:
        FreeCAD.Console.PrintMessage('\n')
        FreeCAD.Console.PrintMessage("Debug : " + str(msg))

_0Vec_ = FreeCAD.Vector(0, 0, 0) #Shortener for null vector
_ZVec_ = FreeCAD.Vector(0, 0, 1) #Shortener for Z axis

if __dbg__:  ##Clear report view in debug mode
    FreeCADGui.getMainWindow().findChild(QtGui.QTextEdit, "Report view").clear()

cslM("Starting SketchUnmap macro")
cslD("Checking selection")

##If selection is wrong, print error message and exit
if (len(Gui.Selection.getSelection()) != 1 or str(Gui.Selection.getSelection()[0]) != '&lt;Sketcher::SketchObject&gt;'):
    cslE("You must select a sketch that you want to unmap (and only one) ... Exiting")
else:
    cslD("Selection OK")
    App.ActiveDocument.openTransaction("SketchUnmap") #Open transaction for undo management
    sk = Gui.Selection.getSelection()[0] #Get target sketch
    skNatPl = sk.Placement #Store placement
    skNatAO = sk.AttachmentOffset #Store attachment offset
    skInBody = False
    for obj in sk.InList: ##Check if sketch is inside a Body
        if obj.TypeId == 'PartDesign::Body':
            skInBody = True
            skBody = obj
    cslD("Sketch in a body : " + str(skInBody))
    msgb = QtGui.QMessageBox() ##Prepare the message box to choose option
    msgb.setWindowTitle("Unmap Sketch : Mode selection")
    msgb.setText("""Choose which unmapping mode you want to apply :
    Raw =&gt; the sketch placement is made absolute in the body referential, nothing more
    DP@Face =&gt; a datum plane is created where the mapping face is, then the sketch is attached to it respecting its attachment offset
    DP@Sketch =&gt; a datum place is created where the sketch is (including attachment offset), then the sketch is attached to its origin
        Click 'Cancel' to cancel operation""")
    msgb.setIcon(QtGui.QMessageBox.Question)
    rbut = msgb.addButton("Raw", QtGui.QMessageBox.AcceptRole)
    fbut = msgb.addButton("DP@Face", QtGui.QMessageBox.AcceptRole)
    sbut = msgb.addButton("DP@Sketch", QtGui.QMessageBox.AcceptRole)
    cbut = msgb.addButton("Cancel", QtGui.QMessageBox.RejectRole)
    if skInBody: #If sketch in a Body
        msgb.exec_() ##Show message box and get user choice
        msgbRep = msgb.clickedButton()
    else:
        msgbRep = rbut #Else apply raw mode automatically
    if msgbRep == rbut: #If raw mode
        sk.Support = None ##Just unmap the sketch so its placement is absolute
        sk.MapMode = 'Deactivated'
    elif msgbRep == fbut: #If DP@Face mode
        newDP = skBody.newObject('PartDesign::Plane','DP' + sk.Name) #Create a datum plane
        if sk.Label != sk.Name: ##Eventually clarify its label
            newDP.Label = 'DP' + sk.Label
        newDP.Support = None ##Plane is placed absolute
        newDP.MapMode = 'Deactivated'
        newDP.Placement = skNatPl.multiply(skNatAO.inverse()) #Plane placement is set to former face one
        sk.Support = [(newDP,'')] #Sketch is mapped to plane keeping its attachment offset
    elif  msgbRep == sbut: #If DP@Sketch mode
        newDP = skBody.newObject('PartDesign::Plane','DP' + sk.Name) #Create a datum plane
        if sk.Label != sk.Name: ##Eventually clarify its label
            newDP.Label = 'DP' + sk.Label
        newDP.Support = None ##Plane is placed absolute
        newDP.MapMode = 'Deactivated'
        newDP.Placement = skNatPl #Plane placement is set to former sketch one
        sk.Support = [(newDP,'')] ##Sketch is mapped to plane resetting its attachment offset
        sk.AttachmentOffset = App.Placement(_0Vec_, App.Rotation(_ZVec_, 0))
    App.ActiveDocument.commitTransaction() #Commit transaction for undo management
    cslM("SketchUnmap Macro ended correctly")</pre>
<h3><span class="mw-headline" id="Limitations">Limitations</span></h3>
<ul><li>Only process one sketch at a time</li>
<li>Only work on sketch objects</li></ul>
<h3><span class="mw-headline" id="Forum_discussion">Forum discussion</span></h3>
<p>For any feedback (bug, feature request, comments, ...), please use this forum thread : <a class="external text" href="https://forum.freecadweb.org/viewtopic.php?f=22&amp;t=36078" rel="nofollow">(FR) macro to remap sketch to different reference</a>
</p>
<!-- 
NewPP limit report
Cached time: 20241214203937
Cache expiry: 86400
Reduced expiry: false
Complications: [show‐toc, no‐toc‐conversion]
CPU time usage: 0.044 seconds
Real time usage: 0.059 seconds
Preprocessor visited node count: 111/1000000
Post‐expand include size: 2458/2097152 bytes
Template argument size: 6661/2097152 bytes
Highest expansion depth: 6/100
Expensive parser function count: 1/100
Unstrip recursion depth: 0/20
Unstrip post‐expand size: 6564/5000000 bytes
-->
<!--
Transclusion expansion time report (%,ms,calls,template)
100.00%    3.469      1 -total
 64.34%    2.232      1 Template:Macro
 32.86%    1.140      1 Template:MacroCode
-->
<!-- Saved in parser cache with key freecadweb_db01-wiki_:pcache:idhash:275815-0!canonical and timestamp 20241214203937 and revision id 1346291. Rendering was triggered because: api-parse
 -->
</div></div><script src="../script.js"></script>
