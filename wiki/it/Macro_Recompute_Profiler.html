<link href="../site.css" rel="stylesheet" type="text/css"/>
<div class="mw-page-container"><h1 class="firstHeading mw-first-heading" id="firstHeading"><span class="mw-page-title-main">Macro Recompute Profiler/it</span></h1><div class="mw-parser-output"><div class="mw-pt-languages noprint" dir="ltr" lang="en"><div class="mw-pt-languages-label">Other languages:</div><ul class="mw-pt-languages-list"><li><a class="mw-pt-languages-ui mw-pt-progress mw-pt-progress--complete" dir="ltr" href="Macro_Recompute_Profiler.html" lang="en" title="Macro Recompute Profiler (100% translated)">English</a></li>
<li><a class="mw-pt-progress mw-pt-progress--complete" dir="ltr" href="Macro_Recompute_Profiler.html" lang="fr" title="Macro Recompute Profiler (100% translated)">français</a></li>
<li><span class="mw-pt-languages-selected mw-pt-progress mw-pt-progress--complete" dir="ltr" lang="it">italiano</span></li>
<li><a class="mw-pt-progress mw-pt-progress--stub" dir="ltr" href="Macro_Recompute_Profiler.html" lang="pl" title="Makrodefinicja: Recompute Profiler (5% translated)">polski</a></li></ul></div>
<table class="fcinfobox wikitable ct" style="float: right; width: 230px; margin-left: 10px;" width="100%">
<tbody><tr>
<td class="ctTitle" style="font-weight: bold; font-size: 125%;">
<p><span typeof="mw:File"><a class="mw-file-description" href="../File/Macro_Recompute_Profiler.png"><img decoding="async" height="32" src="../File/Macro_Recompute_Profiler.png" srcset="/images/thumb/c/ca/Macro_Recompute_Profiler.png/48px-Macro_Recompute_Profiler.png 1.5x, /images/c/ca/Macro_Recompute_Profiler.png 2x" width="32"/></a></span><span> </span>
Macro Recompute Profiler
</p>
</td></tr>
<tr>
<th class="ctOdd">Descrizione
</th></tr>
<tr>
<td class="ctEven left macro-description">Misura il tempo necessario per ricalcolare ogni funzione del progetto<br/><br/>Versione macro: 0.1<br/>Ultima modifica: 2017-04-03<br/>Versione FreeCAD: 0.17.10644 e più alto<br/>Download: <a class="external text" href="https://www.freecadweb.org/wiki/images/c/ca/Macro_Recompute_Profiler.png" rel="nofollow">ToolBar Icon</a><br/>Autore: DeepSOIC<br/>
</td></tr>
<tr>
<th class="ctOdd">Autore
</th></tr>
<tr>
<td class="ctEven macro-author"><a href="User;DeepSOIC.html" title="User:DeepSOIC">DeepSOIC</a>
</td></tr>
<tr>
<th class="ctOdd">Download
</th></tr>
<tr>
<td class="ctEven macro-download"><a class="external text" href="https://www.freecadweb.org/wiki/images/c/ca/Macro_Recompute_Profiler.png" rel="nofollow">ToolBar Icon</a>
</td></tr>
<tr>
<th class="ctOdd">Link
</th></tr>
<tr>
<td class="ctEven macro-Links"><a href="Macros_recipes.html" title="Macros recipes/it">Raccolta di macro</a><br/><a href="How_to_install_macros.html" title="How to install macros/it">Come installare le macro</a><br/><a href="Customize_Toolbars.html" title="Customize Toolbars/it">Personalizzare la  toolbar</a>
</td></tr>
<tr>
<th class="ctOdd">Versione macro
</th></tr>
<tr>
<td class="ctEven macro-version">0.1
</td></tr>
<tr>
<th class="ctOdd">Data ultima modifica
</th></tr>
<tr>
<td class="ctEven macro-date">2017-04-03
</td></tr>
<tr>
<th class="ctOdd">Versioni di FreeCAD
</th></tr>
<tr>
<td class="ctEven FreeCAD-version">0.17.10644 e più alto
</td></tr>
<tr>
<th class="ctOdd">Scorciatoia
</th></tr>
<tr>
<td class="ctEven"><i>Nessuna</i>
</td></tr>
<tr>
<th class="ctOdd">Vedere anche
</th></tr>
<tr>
<td class="ctEven"><i>Nessuno</i>
</td></tr>
<tr>
<th class="ctOdd">
</th></tr>
<tr>
<td class="ctToc"><br/><div aria-labelledby="mw-toc-heading" class="toc" id="toc" role="navigation"><input class="toctogglecheckbox" id="toctogglecheckbox" role="button" style="display:none" type="checkbox"/><div class="toctitle" dir="ltr" lang="en"><h2 id="mw-toc-heading">Contents</h2><span class="toctogglespan"><label class="toctogglelabel" for="toctogglecheckbox"></label></span></div>
<ul>
<li class="toclevel-1 tocsection-1"><a href="#Descrizione"><span class="tocnumber">1</span> <span class="toctext">Descrizione</span></a></li>
<li class="toclevel-1 tocsection-2"><a href="#Utilizzo"><span class="tocnumber">2</span> <span class="toctext">Utilizzo</span></a></li>
<li class="toclevel-1 tocsection-3"><a href="#Macro"><span class="tocnumber">3</span> <span class="toctext">Macro</span></a></li>
<li class="toclevel-1 tocsection-4"><a href="#Post-processing_resultati"><span class="tocnumber">4</span> <span class="toctext">Post-processing resultati</span></a></li>
<li class="toclevel-1 tocsection-5"><a href="#Versione_di_FreeCAD"><span class="tocnumber">5</span> <span class="toctext">Versione di FreeCAD</span></a></li>
</ul>
</div>
</td></tr>
</tbody></table>
<p><span id="Description"></span>
</p>
<h2><span class="mw-headline" id="Descrizione">Descrizione</span></h2>
<p>Questa macro serve per trovare quali sono le funzioni che causano lunghi ritardi negli aggiornamenti del progetto. Essa esegue un ricalcolo, misurando il tempo necessario per ricalcolare ogni funzione.
</p><p><span id="Usage"></span>
</p>
<h2><span class="mw-headline" id="Utilizzo">Utilizzo</span></h2>
<p>Questa macro richiede almeno la versione 0.17.10644 di FreeCAD
</p><p>Salvare la macro in un file.
</p><p>1. Aprire il progetto
</p><p>2. Fare clic destro su un oggetto nella struttura ad albero del modello, selezionare "Marca da ricalcolare"
</p><p>3. Avviare questa macro.
</p><p>Appare una barra di avanzamento. Man mano che ogni oggetto viene ricalcolato, viene stampata una riga nel pannello Report, che contiene il tempo e l'etichetta dell'oggetto. Se FreeCAD non riesce a ricalcolare un oggetto, la macro visualizza un messaggio di errore e termina il processo.
</p>
<h2><span class="mw-headline" id="Macro">Macro</span></h2>
<p>Icona barra strumenti
<span class="mw-default-size" typeof="mw:File"><a class="mw-file-description" href="../File/Macro_Recompute_Profiler.png"><img decoding="async" height="64" src="../File/Macro_Recompute_Profiler.png" width="64"/></a></span>
</p><p><b>RecomputeProfiler.FCMacro</b>
</p>
<pre>__Title__="Macro Recompute Profiler"
__Author__ = "DeepSOIC"
__Version__ = "0.1"
__Date__    = "03.04.2017"

__Comment__ = "Measures time it takes to recmpute features in a project"
__Wiki__ = "https://www.freecadweb.org/wiki/index.php?title=Macro_Recompute_Profiler"
__Help__ = "Right-click an object, and pick 'Mark to recompute', then run this macro. This will only profile recomputing the subgraph. To profile the whole project, right-click the project in tree view, and pick 'Mark to recompute', then run this macro. Results will be printed to report view."
__Status__ = "experimental"
__Requires__ = "freecad 0.17.10644"
__Communication__ = "https://forum.freecadweb.org/memberlist.php?mode=viewprofile&amp;u=3888" 

import FreeCAD as App

import FreeCADGui as Gui

class ExecutionError(Exception):
    pass

class CancelError(Exception):
    pass

def execute(feature):
    feature.recompute()
    if 'Invalid' in feature.State:
        raise ExecutionError("Feature '{label}' failed to recompute".format(label= feature.Label))

def msgbox(title, text):
    from PySide import QtGui
    mb = QtGui.QMessageBox()
    mb.setIcon(mb.Icon.Information)
    mb.setText(text)
    mb.setWindowTitle(title)
    mb.exec_()

def log(string):
    App.Console.PrintWarning(string+"\n")

def getAllDependent(feat_list):
    '''getAllDependent(feat_list): gets all features that depend on features in feat_list, directly or indirectly.
    Returns a set. Features from feat_list are not included, unless there are interdependencies between them.'''

    list_traversing_now = feat_list
    set_of_deps = set()
    list_of_deps = []

    while len(list_traversing_now) &gt; 0:
        list_to_be_traversed_next = []
        for feat in list_traversing_now:
            for dep in feat.InList:
                if not (dep in set_of_deps):
                    set_of_deps.add(dep)
                    list_of_deps.append(dep)
                    list_to_be_traversed_next.append(dep)

        list_traversing_now = list_to_be_traversed_next

    return set_of_deps


def run():
    touched = [obj for obj in App.ActiveDocument.Objects if 'Touched' in obj.State]

    if len(touched) == 0:
        App.ActiveDocument.RecomputesFrozen = True
        msgbox("Macro Recompute Profiler", "Project was switched to suspend recomputes. Please modify an object that triggers a recompute, and run this macro again. The macro will perform a step-by-step recompute, and measure the time it takes to recompute features.")
        return

    log("{n} features are touched".format(n= len(touched)))

    log("Generating execution order...")

    to_be_executed = set.union(getAllDependent(touched), set(touched))
    log("Number of features to execute: {n}".format(n= len(to_be_executed)))

    exec_list = []
    for obj in App.ActiveDocument.TopologicalSortedObjects[::-1]:
        if obj in to_be_executed:
            exec_list.append(obj)
    assert(len(exec_list) == len(to_be_executed))
    n = len(exec_list)

    log("Execution order:")
    for obj in exec_list:
        log("    "+obj.Label)


    import PySide
    progress = PySide.QtGui.QProgressDialog(u"Preparing to recompute....", u"Abort", 0, n+1)
    progress.setModal(True)
    progress.show()
    
    try:
        log("Recomputing... (time in seconds, label)")
        import time
        for obj in exec_list:
            progress.setValue(progress.value()+1)
            progress.setLabelText("Recomputing {feature}...".format(feature= obj.Label))
            if progress.wasCanceled():
                raise CancelError()

            time_start = time.time()
            try:
                execute(obj)
            finally:
                exec_time = time.time()-time_start
                log("\t{time}\t{label}".format(time= exec_time, label= obj.Label))

        progress.setValue(n+1)
        msgbox("Macro Recompute Profiler", "Recompute completed. Results are in report view.")

        for obj in exec_list:
            obj.purgeTouched()

    except Exception as err:
        msgbox("Macro Recompute Profiler", "An error occured: {err}".format(err= str(err)))
    finally:
        progress.hide()
        App.ActiveDocument.RecomputesFrozen = False

run()</pre>
<p><span id="Post-processing_results"></span>
</p>
<h2><span class="mw-headline" id="Post-processing_resultati">Post-processing resultati</span></h2>
<p>La sortita della macro sarà interfogliato con i messaggi generici prodotti dalle funzioni di ricalcolo. Generalmente si presenta così:
</p>
<div class="mw-highlight mw-highlight-lang-python mw-content-ltr" dir="ltr"><pre><span></span><span class="n">Recomputing</span><span class="o">...</span> <span class="p">(</span><span class="n">time</span> <span class="ow">in</span> <span class="n">seconds</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
<span class="n">Sketcher</span><span class="p">::</span><span class="n">setUpSketch</span><span class="p">()</span><span class="o">-</span><span class="n">T</span><span class="p">:</span><span class="mi">0</span>
<span class="n">Sketcher</span><span class="p">::</span><span class="n">Solve</span><span class="p">()</span><span class="o">-</span><span class="n">DogLeg</span><span class="o">-</span><span class="n">T</span><span class="p">:</span><span class="mi">0</span>
	<span class="mf">0.00999999046326</span>	<span class="n">Sketch</span> <span class="o">-</span> <span class="n">master</span> <span class="n">section</span>
	<span class="mf">0.0199999809265</span>	<span class="n">Clone</span> <span class="n">of</span> <span class="n">Sketch</span> <span class="o">-</span> <span class="n">master</span> <span class="n">section</span> <span class="p">(</span><span class="mi">2</span><span class="n">D</span><span class="p">)</span><span class="mi">001</span>
<span class="n">Sketcher</span><span class="p">::</span><span class="n">setUpSketch</span><span class="p">()</span><span class="o">-</span><span class="n">T</span><span class="p">:</span><span class="mi">0</span>
<span class="n">Sketcher</span><span class="p">::</span><span class="n">Solve</span><span class="p">()</span><span class="o">-</span><span class="n">DogLeg</span><span class="o">-</span><span class="n">T</span><span class="p">:</span><span class="mi">0</span>
	<span class="mf">0.00999999046326</span>	<span class="n">Sketch013</span>
<span class="n">Sketcher</span><span class="p">::</span><span class="n">setUpSketch</span><span class="p">()</span><span class="o">-</span><span class="n">T</span><span class="p">:</span><span class="mi">0</span>
<span class="n">Sketcher</span><span class="p">::</span><span class="n">Solve</span><span class="p">()</span><span class="o">-</span><span class="n">DogLeg</span><span class="o">-</span><span class="n">T</span><span class="p">:</span><span class="mi">0</span>
	<span class="mf">0.00999999046326</span>	<span class="n">Sketch011</span>
	<span class="mf">0.0</span>	<span class="n">Clone</span> <span class="n">of</span> <span class="n">Sketch</span> <span class="o">-</span> <span class="n">master</span> <span class="n">section</span> <span class="p">(</span><span class="mi">2</span><span class="n">D</span><span class="p">)</span>
<span class="n">Sketcher</span><span class="p">::</span><span class="n">setUpSketch</span><span class="p">()</span><span class="o">-</span><span class="n">T</span><span class="p">:</span><span class="mi">0</span>
<span class="n">Sketcher</span><span class="p">::</span><span class="n">Solve</span><span class="p">()</span><span class="o">-</span><span class="n">DogLeg</span><span class="o">-</span><span class="n">T</span><span class="p">:</span><span class="mi">0</span>
	<span class="mf">0.0</span>	<span class="n">Sketch008</span>
	<span class="mf">0.130000114441</span>	<span class="n">LinearArray</span>
<span class="n">Sketcher</span><span class="p">::</span><span class="n">setUpSketch</span><span class="p">()</span><span class="o">-</span><span class="n">T</span><span class="p">:</span><span class="mi">0</span>
<span class="n">Sketcher</span><span class="p">::</span><span class="n">Solve</span><span class="p">()</span><span class="o">-</span><span class="n">DogLeg</span><span class="o">-</span><span class="n">T</span><span class="p">:</span><span class="mi">0</span>
<span class="o">...</span>
</pre></div>
<p>Le righe dei risultati hanno una firma semplice per separarle: iniziano con una scheda. Quindi, se copi e incolli l'intero blocco su un foglio di calcolo, i messaggi generici finiranno nella colonna 1, mentre i risultati saranno nelle colonne 2 e 3. Quindi, puoi ordinare per colonna 2, per ottenere una tabella simile a quella :
</p>
<div class="mw-highlight mw-highlight-lang-python mw-content-ltr" dir="ltr"><pre><span></span><span class="mf">0.59100008</span>	<span class="n">Slice</span>
<span class="mf">0.352999926</span>	<span class="n">Populate</span> <span class="n">LinearArray</span> <span class="k">with</span> <span class="n">Compound</span>
<span class="mf">0.160000086</span>	<span class="n">CompoundFilter</span>
<span class="mf">0.138999939</span>	<span class="n">Cut</span>
<span class="mf">0.130000114</span>	<span class="n">LinearArray</span>
<span class="mf">0.108999968</span>	<span class="n">Fusion</span>
<span class="mf">0.069999933</span>	<span class="n">Moved</span> <span class="n">CompoundFilter</span>
<span class="mf">0.067000151</span>	<span class="n">Module</span> <span class="o">-</span> <span class="n">spokes</span>
<span class="mf">0.029999971</span>	<span class="n">Sweep</span>
<span class="mf">0.019999981</span>	<span class="n">Clone</span> <span class="n">of</span> <span class="n">Sketch</span> <span class="o">-</span> <span class="n">master</span> <span class="n">section</span> <span class="p">(</span><span class="mi">2</span><span class="n">D</span><span class="p">)</span><span class="mi">001</span>
<span class="mf">0.010999918</span>	<span class="n">ArrayFilter003</span>
<span class="o">...</span>
</pre></div>
<p>(Per MS-Excel, facendo copia-incolla del testo dal rapporto non lo divide in colonne, non so perché ... incollando il testo in Notepad e ri-copiandolo poi da Notepad funziona meglio.)
</p><p><span id="FreeCAD_version"></span>
</p>
<h2><span class="mw-headline" id="Versione_di_FreeCAD">Versione di FreeCAD</span></h2>
<p>Questa macro richiede una versione di FreeCAD non inferiore alla 0.17.10644, che è la versione in cui è stato reso disponibile App.ActiveDocument.RecomputesFrozen. Potrebbe essere funzionare anche con una vesrsione di FreeCAD un po' più vecchia, ma certamente non funziona con v0.16.
</p><p>Questa macro è stata creata usando questa versione di FreeCAD:
</p>
<div class="mw-highlight mw-highlight-lang-python mw-content-ltr" dir="ltr"><pre><span></span><span class="n">OS</span><span class="p">:</span> <span class="n">Windows</span> <span class="mi">10</span>
<span class="n">Word</span> <span class="n">size</span> <span class="n">of</span> <span class="n">OS</span><span class="p">:</span> <span class="mi">64</span><span class="o">-</span><span class="n">bit</span>
<span class="n">Word</span> <span class="n">size</span> <span class="n">of</span> <span class="n">FreeCAD</span><span class="p">:</span> <span class="mi">64</span><span class="o">-</span><span class="n">bit</span>
<span class="n">Version</span><span class="p">:</span> <span class="mf">0.17.10665</span> <span class="p">(</span><span class="n">Git</span><span class="p">)</span>
<span class="n">Build</span> <span class="nb">type</span><span class="p">:</span> <span class="n">Release</span>
<span class="n">Branch</span><span class="p">:</span> <span class="n">master</span>
<span class="n">Hash</span><span class="p">:</span> <span class="mi">47847513</span><span class="n">a85ff6615774ef628230f79e37471daf</span>
<span class="n">Python</span> <span class="n">version</span><span class="p">:</span> <span class="mf">2.7.8</span>
<span class="n">Qt</span> <span class="n">version</span><span class="p">:</span> <span class="mf">4.8.7</span>
<span class="n">Coin</span> <span class="n">version</span><span class="p">:</span> <span class="mf">4.0.0</span><span class="n">a</span>
<span class="n">OCC</span> <span class="n">version</span><span class="p">:</span> <span class="mf">7.0.0</span>
</pre></div>
<!-- 
NewPP limit report
Cached time: 20241129211727
Cache expiry: 86400
Reduced expiry: false
Complications: [show‐toc, no‐toc‐conversion]
CPU time usage: 0.063 seconds
Real time usage: 0.564 seconds
Preprocessor visited node count: 140/1000000
Post‐expand include size: 2459/2097152 bytes
Template argument size: 5933/2097152 bytes
Highest expansion depth: 7/100
Expensive parser function count: 5/100
Unstrip recursion depth: 0/20
Unstrip post‐expand size: 11975/5000000 bytes
-->
<!--
Transclusion expansion time report (%,ms,calls,template)
100.00%  495.101      1 -total
 99.18%  491.049      3 Template:Code
  0.53%    2.648      1 Template:Macro/it
  0.19%    0.942      1 Template:MacroCode
-->
<!-- Saved in parser cache with key freecadweb_db01-wiki_:pcache:idhash:79645-0!canonical and timestamp 20241129211727 and revision id 1232745. Rendering was triggered because: api-parse
 -->
</div></div><script src="../script.js"></script>
